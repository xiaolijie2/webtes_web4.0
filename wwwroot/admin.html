<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            overflow-x: hidden;
        }

        /* 主布局容器 */
        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* 左侧导航菜单 */
        .sidebar {
            width: 240px;
            background-color: #2c3e50;
            color: #ecf0f1;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        /* 顶部标题栏 */
        .sidebar-header {
            padding: 20px;
            background-color: #34495e;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

        .sidebar-header h4 {
            color: #ecf0f1;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-header .user-info {
            margin-top: 10px;
            font-size: 12px;
            color: #bdc3c7;
        }

        .sidebar-header .header-actions {
            margin-top: 15px;
        }

        .sidebar-header .btn {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0 3px;
        }

        /* 导航菜单 */
        .nav-menu {
            padding: 0;
            list-style: none;
        }

        .nav-item {
            border-bottom: 1px solid #34495e;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .nav-link:hover {
            background-color: #34495e;
            color: #3498db;
        }

        .nav-link.active {
            background-color: #34495e;
            color: #ff6b35;
            border-left: 4px solid #ff6b35;
        }

        .nav-link i {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }



        /* 主内容区域 */
        .main-content {
            flex: 1;
            margin-left: 240px;
            background-color: #ffffff;
            min-height: 100vh;
        }

        /* 顶部面包屑导航 */
        .content-header {
            background-color: #ffffff;
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .breadcrumb-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .breadcrumb-nav h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
        }

        .breadcrumb {
            background: none;
            padding: 0;
            margin: 0;
        }

        .breadcrumb-item {
            color: #6c757d;
        }

        .breadcrumb-item.active {
            color: #2c3e50;
        }

        /* 分类菜单栏 */
        .category-menu {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 0;
        }

        .category-nav {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .category-nav .nav-item {
            border-right: 1px solid #e9ecef;
        }

        .category-nav .nav-item:last-child {
            border-right: none;
        }

        .category-nav .nav-link {
            display: block;
            padding: 15px 20px;
            color: #6c757d;
            text-decoration: none;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .category-nav .nav-link:hover {
            background-color: #e9ecef;
            color: #2c3e50;
        }

        .category-nav .nav-link.active {
            background-color: #ffffff;
            color: #2c3e50;
            border-bottom-color: #ff6b35;
            font-weight: 600;
        }

        /* 内容面板 */
        .content-panel {
            padding: 30px;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 卡片样式 */
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
        }

        .card-header h5 {
            margin: 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        /* 表单样式 */
        .form-label {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .form-control {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px 15px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        /* 按钮样式 */
        .btn {
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            border-color: #27ae60;
        }

        .btn-danger {
            background-color: #e74c3c;
            border-color: #e74c3c;
        }

        .btn-warning {
            background-color: #ff6b35;
            border-color: #ff6b35;
        }

        /* 表格样式 */
        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #2c3e50;
            padding: 12px;
        }

        .table tbody td {
            padding: 12px;
            vertical-align: middle;
            border-bottom: 1px solid #dee2e6;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* 状态标签 */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* 状态圆点样式 */
        .status-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: inline-block;
            margin: 0 auto;
        }

        .status-dot:hover {
            transform: scale(1.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* 启用状态圆点 */
        .status-dot.enabled {
            background-color: #28a745;
            border: 2px solid #28a745;
        }

        .status-dot.disabled {
            background-color: #6c757d;
            border: 2px solid #6c757d;
        }

        /* 默认状态圆点 */
        .default-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: inline-block;
            margin: 0 auto;
        }

        .default-dot:hover {
            transform: scale(1.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .default-dot.is-default {
            background-color: #ffc107;
            border: 2px solid #ffc107;
        }

        .default-dot.not-default {
            background-color: transparent;
            border: 2px solid #dee2e6;
        }

        .default-dot.not-default:hover {
            border-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }

        /* 上传区域 */
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background-color: #e3f2fd;
            border-color: #2980b9;
        }

        .upload-area i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }

        /* 工具提示 */
        .tooltip-inner {
            background-color: #2c3e50;
        }

        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* LOGO设置样式 */
        .logo-settings-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .logo-settings-section .form-label {
            font-weight: 600;
            color: #495057;
        }

        .form-range {
            width: 100%;
        }

        .form-control-color {
            width: 60px;
            height: 38px;
            border-radius: 6px;
        }

        #logoPreviewContainer {
            min-height: 120px;
            background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%), 
                        linear-gradient(-45deg, #f8f9fa 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f8f9fa 75%), 
                        linear-gradient(-45deg, transparent 75%, #f8f9fa 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: 8px;
        }

        #logoPreviewContent {
            background-color: white;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background-color: #e3f2fd;
        }

        .upload-area h6 {
            color: #3498db;
            margin: 10px 0 5px 0;
        }

        #currentLogoImage {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #logoImagePreview {
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .btn-group .btn-check:checked + .btn {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }

        .input-group .form-range {
            flex: 1;
            margin-right: 10px;
        }

        .text-primary {
            color: #0d6efd !important;
        }

        /* LOGO布局样式 */
        .logo-layout-horizontal {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-layout-vertical {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .logo-layout-overlay {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }

        .logo-layout-overlay .logo-image {
            position: absolute;
            z-index: 1;
        }

        .logo-layout-overlay .logo-text {
            position: relative;
            z-index: 2;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* 图片位置按钮组样式 */
        .image-position-group {
            margin-bottom: 10px;
        }

        /* 拖拽排序样式 */
        .sortable-row {
            transition: all 0.3s ease;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #f8f9fa;
        }

        .sortable-chosen {
            background-color: #e3f2fd;
        }

        .sortable-drag {
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: rotate(5deg);
        }

        .sortable-handle {
            cursor: move;
            user-select: none;
        }

        .sortable-handle:hover {
            color: #0d6efd !important;
        }

        .image-position-group .btn {
            font-size: 14px;
            padding: 8px 12px;
        }

        .image-position-group .btn i {
            margin-right: 5px;
        }



        .drop-zone {
            border: 2px dashed #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }

        /* 拖拽手柄改进 */
        .drag-handle {
            cursor: grab;
            user-select: none;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .drag-handle:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .drag-handle:active {
            cursor: grabbing;
            background-color: rgba(0, 123, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- 左侧导航菜单 -->
        <nav class="sidebar">
            <!-- 顶部标题栏 -->
            <div class="sidebar-header">
                <h4><i class="fas fa-cogs"></i> 管理系统</h4>
                <div class="user-info" id="userInfoDisplay">
                    <i class="fas fa-user-circle"></i> <span id="userTypeLabel">管理员</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-outline-light btn-sm" onclick="goToHome()" title="返回首页">
                        <i class="fas fa-home"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()" title="退出登录">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- 导航菜单 -->
            <ul class="nav-menu">
                <!-- 网站设置 -->
                <li class="nav-item">
                    <a class="nav-link active" data-section="website-settings">
                        <i class="fas fa-globe"></i>
                        <span>网站设置</span>
                    </a>
                </li>

                <!-- 会员管理 -->
                <li class="nav-item">
                    <a class="nav-link" data-section="member-management">
                        <i class="fas fa-users"></i>
                        <span>会员管理</span>
                    </a>
                </li>

                <!-- 订单管理 -->
                <li class="nav-item">
                    <a class="nav-link" data-section="order-management">
                        <i class="fas fa-shopping-cart"></i>
                        <span>订单管理</span>
                    </a>
                </li>

                <!-- 收款管理 -->
                <li class="nav-item">
                    <a class="nav-link" data-section="payment-management">
                        <i class="fas fa-credit-card"></i>
                        <span>收款管理</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 顶部面包屑导航 -->
            <div class="content-header">
                <div class="breadcrumb-nav">
                    <h2 id="page-title">网站设置</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">管理系统</li>
                            <li class="breadcrumb-item active" id="section-breadcrumb">网站设置</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <!-- 分类菜单栏 -->
            <div class="category-menu">
                <ul class="category-nav" id="category-nav">
                    <!-- 动态生成分类菜单 -->
                </ul>
            </div>

            <!-- 内容面板 -->
            <div class="content-panel">
                <!-- 基础信息设置 -->
                <div id="basic-info" class="content-section active">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cog text-primary"></i> 基础信息设置</h5>
                        </div>
                        <div class="card-body">
                            <form id="basic-info-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">网站名称</label>
                                            <input type="text" class="form-control" id="siteName" value="网站管理系统" placeholder="请输入网站名称">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">联系电话</label>
                                            <input type="text" class="form-control" id="contactPhone" value="400-000-0000" placeholder="请输入联系电话">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label class="form-label">网站描述</label>
                                            <textarea class="form-control" id="siteDescription" rows="3" placeholder="请输入网站描述">专业的网站管理系统，提供全面的管理功能</textarea>
                                        </div>
                                    </div>
                                </div>
                                <!-- LOGO管理区域 -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-4">
                                            <h6 class="text-primary"><i class="fas fa-image"></i> LOGO设置</h6>
                                            <hr>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- LOGO类型选择 -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label class="form-label">LOGO类型</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="logoType" id="logoTypeText" value="text">
                                                <label class="btn btn-outline-primary" for="logoTypeText">纯文字</label>
                                                
                                                <input type="radio" class="btn-check" name="logoType" id="logoTypeImage" value="image">
                                                <label class="btn btn-outline-primary" for="logoTypeImage">纯图片</label>
                                                
                                                <input type="radio" class="btn-check" name="logoType" id="logoTypeCombined" value="combined" checked>
                                                <label class="btn btn-outline-primary" for="logoTypeCombined">图片+文字</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 文字设置区域 -->
                                <div id="textSettings" class="logo-settings-section">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">LOGO文字</label>
                                                <input type="text" class="form-control" id="logoText" placeholder="请输入LOGO文字" value="SheIn1323">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">字体大小</label>
                                                <div class="input-group">
                                                    <input type="range" class="form-range" id="fontSize" min="12" max="48" value="24" oninput="updateFontSizeDisplay(this.value)">
                                                    <span class="input-group-text" id="fontSizeDisplay">24px</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">字体颜色</label>
                                                <input type="color" class="form-control form-control-color" id="fontColor" value="#333333">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">字体粗细</label>
                                                <select class="form-select" id="fontWeight">
                                                    <option value="300">细体</option>
                                                    <option value="400" selected>正常</option>
                                                    <option value="500">中等</option>
                                                    <option value="600">半粗</option>
                                                    <option value="700">粗体</option>
                                                    <option value="800">特粗</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">字体</label>
                                                <select class="form-select" id="fontFamily">
                                                    <option value="Arial, sans-serif">Arial</option>
                                                    <option value="'Microsoft YaHei', sans-serif" selected>微软雅黑</option>
                                                    <option value="'SimHei', sans-serif">黑体</option>
                                                    <option value="'SimSun', serif">宋体</option>
                                                    <option value="'KaiTi', serif">楷体</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 图片设置区域 -->
                                <div id="imageSettings" class="logo-settings-section">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">LOGO图片</label>
                                                <div class="upload-area" onclick="document.getElementById('logoImageFile').click()">
                                                    <i class="fas fa-cloud-upload-alt"></i>
                                                    <h6>点击上传LOGO图片</h6>
                                                    <p class="text-muted mb-0">支持 PNG、JPG 格式，建议尺寸 200x60</p>
                                                    <input type="file" id="logoImageFile" accept="image/*" style="display: none;" onchange="handleLogoImageUpload(this)">
                                                </div>
                                                <div id="currentLogoImage" class="mt-2" style="display: none;">
                                                    <img id="logoImagePreview" src="" alt="当前LOGO" style="max-width: 200px; max-height: 60px;" class="border rounded">
                                                    <button type="button" class="btn btn-sm btn-danger ms-2" onclick="removeLogoImage()">
                                                        <i class="fas fa-trash"></i> 删除
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">图片位置</label>
                                                <div class="row">
                                                    <div class="col-12 mb-2">
                                                        <div class="btn-group w-100" role="group">
                                                            <input type="radio" class="btn-check" name="imagePosition" id="imageLeft" value="left" checked>
                                                            <label class="btn btn-outline-secondary" for="imageLeft">
                                                                <i class="fas fa-align-left"></i> 左侧
                                                            </label>
                                                            
                                                            <input type="radio" class="btn-check" name="imagePosition" id="imageRight" value="right">
                                                            <label class="btn btn-outline-secondary" for="imageRight">
                                                                <i class="fas fa-align-right"></i> 右侧
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="btn-group w-100" role="group">
                                                            <input type="radio" class="btn-check" name="imagePosition" id="imageTop" value="top">
                                                            <label class="btn btn-outline-secondary" for="imageTop">
                                                                <i class="fas fa-arrow-up"></i> 上方
                                                            </label>
                                                            
                                                            <input type="radio" class="btn-check" name="imagePosition" id="imageCenter" value="center">
                                                            <label class="btn btn-outline-secondary" for="imageCenter">
                                                                <i class="fas fa-dot-circle"></i> 中间
                                                            </label>
                                                            
                                                            <input type="radio" class="btn-check" name="imagePosition" id="imageBottom" value="bottom">
                                                            <label class="btn btn-outline-secondary" for="imageBottom">
                                                                <i class="fas fa-arrow-down"></i> 下方
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- LOGO预览区域 -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label class="form-label">LOGO预览</label>
                                            <div class="border rounded p-4 text-center bg-light" style="min-height: 120px; display: flex; align-items: center; justify-content: center;">
                                                <div id="logoPreviewContainer" class="d-flex align-items-center justify-content-center">
                                                    <div id="logoPreviewContent" class="text-muted">
                                                        <i class="fas fa-image fa-2x"></i>
                                                        <p class="mt-2 mb-0">LOGO预览将在这里显示</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- LOGO操作按钮 -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-info me-2" onclick="previewLogo()">
                                                <i class="fas fa-eye"></i> 预览效果
                                            </button>
                                            <button type="button" class="btn btn-success me-2" onclick="saveLogoSettings()">
                                                <i class="fas fa-save"></i> 保存LOGO设置
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="resetLogoSettings()">
                                                <i class="fas fa-undo"></i> 重置设置
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button type="button" class="btn btn-secondary me-2">重置</button>
                                    <button type="submit" class="btn btn-primary">保存设置</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- 轮播图管理 -->
                <div id="slideshow" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-images text-primary"></i> 轮播图管理</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <button class="btn btn-success" onclick="addSlideshow()">
                                    <i class="fas fa-plus"></i> 添加轮播图
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>排序</th>
                                            <th>预览</th>
                                            <th>标题</th>
                                            <th>描述</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="slideshowList">
                                        <!-- 轮播图列表将通过JavaScript动态加载 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 手机区号管理 -->
                <div id="country-codes" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-globe text-primary"></i> 手机区号管理</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <button class="btn btn-success" onclick="addCountryCode()">
                                    <i class="fas fa-plus"></i> 添加区号
                                </button>
                                <button class="btn btn-info ms-2" onclick="loadCountryCodes()">
                                    <i class="fas fa-refresh"></i> 刷新列表
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="40"><i class="fas fa-grip-vertical text-muted" title="拖拽排序"></i></th>
                                            <th>排序</th>
                                            <th>国旗</th>
                                            <th>国家/地区</th>
                                            <th>国家代码</th>
                                            <th>电话区号</th>
                                            <th>状态</th>
                                            <th>默认</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="countryCodesList">
                                        <!-- 区号列表将通过JavaScript动态加载 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIP等级管理 -->
                <div id="vip-levels" class="content-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-crown text-primary"></i> VIP等级管理</h5>
                            <small class="text-muted">管理系统的4个固定VIP等级</small>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>说明：</strong>系统包含4个固定的VIP等级，您可以编辑每个等级的基本信息、权益内容、颜色和图标设置。等级顺序和数量不可更改。
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="80">等级</th>
                                            <th>名称</th>
                                            <th>最低充值</th>
                                            <th>佣金率</th>
                                            <th>每日订单</th>
                                            <th>提现限额</th>
                                            <th>权益数量</th>
                                            <th>状态</th>
                                            <th width="180">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vipLevelsList">
                                        <!-- VIP等级列表将通过JavaScript动态加载 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 会员列表 -->
                <div id="member-list" class="content-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-users text-primary"></i> 会员列表</h5>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshMemberList()">
                                <i class="fas fa-sync-alt"></i> 刷新
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- 搜索和筛选区域 -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <input type="text" id="memberSearchInput" class="form-control" placeholder="搜索手机号/昵称" onkeyup="handleMemberSearch(event)">
                                </div>
                                <div class="col-md-2">
                                    <select id="memberStatusFilter" class="form-select" onchange="filterMembers()">
                                        <option value="">全部状态</option>
                                        <option value="true">正常</option>
                                        <option value="false">禁用</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select id="memberVipFilter" class="form-select" onchange="filterMembers()">
                                        <option value="">全部VIP等级</option>
                                        <option value="1">VIP 1 🥉</option>
                                        <option value="2">VIP 2 🥈</option>
                                        <option value="3">VIP 3 🥇</option>
                                        <option value="4">VIP 4 👑</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary" onclick="searchMembers()">
                                        <i class="fas fa-search"></i> 搜索
                                    </button>
                                </div>
                                <div class="col-md-3 text-end">
                                    <small class="text-muted">共 <span id="memberTotalCount">0</span> 名会员</small>
                                </div>
                            </div>
                            
                            <!-- 会员列表表格 -->
                            <div class="table-responsive">
                                <table class="table table-hover table-striped">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="15%">账号</th>
                                            <th width="15%">密码</th>
                                            <th width="15%">邀请码</th>
                                            <th width="10%">客户数</th>
                                            <th width="15%">创建时间</th>
                                            <th width="30%">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="membersList">
                                        <tr>
                                            <td colspan="6" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">加载中...</span>
                                                </div>
                                                <div class="mt-2">正在加载会员数据...</div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- 分页控件 -->
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    <select id="memberPageSize" class="form-select form-select-sm" style="width: auto;" onchange="changeMemberPageSize()">
                                        <option value="10">每页 10 条</option>
                                        <option value="20">每页 20 条</option>
                                        <option value="50">每页 50 条</option>
                                    </select>
                                </div>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0" id="memberPagination">
                                        <!-- 分页按钮将通过JavaScript动态生成 -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- 订单列表 -->
                <div id="order-list" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-shopping-cart text-primary"></i> 订单列表</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" placeholder="搜索订单号">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select">
                                        <option>全部状态</option>
                                        <option>待付款</option>
                                        <option>已付款</option>
                                        <option>已完成</option>
                                        <option>已取消</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary">搜索</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>订单号</th>
                                            <th>用户</th>
                                            <th>金额</th>
                                            <th>状态</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>ORD20240101001</td>
                                            <td>示例用户</td>
                                            <td>¥99.00</td>
                                            <td><span class="status-badge status-active">已付款</span></td>
                                            <td>2024-01-01 10:00:00</td>
                                            <td>
                                                <button class="btn btn-sm btn-primary me-1">查看</button>
                                                <button class="btn btn-sm btn-warning">处理</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 订单详情 -->
                <div id="order-details" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-file-invoice text-primary"></i> 订单详情</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">选择订单后显示详细信息</p>
                        </div>
                    </div>
                </div>

                <!-- 业务员列表 -->
                <div id="staff-list" class="content-section">
                    <!-- 业务员统计卡片 -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0" id="totalStaff">0</h4>
                                            <p class="mb-0">总业务员</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-users fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0" id="activeStaff">0</h4>
                                            <p class="mb-0">活跃业务员</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-user-check fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0" id="totalCustomers">0</h4>
                                            <p class="mb-0">总客户数</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-user-friends fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0" id="inactiveStaff">0</h4>
                                            <p class="mb-0">禁用业务员</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-user-times fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-user-tie text-primary"></i> 业务员管理</h5>
                            <button class="btn btn-success" onclick="showAddStaffModal()">
                                <i class="fas fa-plus"></i> 添加业务员
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="searchStaff" placeholder="搜索昵称、账号或邀请码">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" id="filterStaffStatus">
                                        <option value="">全部状态</option>
                                        <option value="active">正常</option>
                                        <option value="inactive">禁用</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary" onclick="searchStaff()">
                                        <i class="fas fa-search"></i> 搜索
                                    </button>
                                </div>
                                <div class="col-md-2 ms-auto">
                                    <button class="btn btn-info" onclick="loadStaffList()">
                                        <i class="fas fa-sync-alt"></i> 刷新
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>账号</th>
                                            <th>密码</th>
                                            <th>邀请码</th>
                                            <th>客户数</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="staffTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <div class="loading"></div>
                                                正在加载业务员列表...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 收款账户管理 -->
                <div id="payment-accounts" class="content-section">
                    <!-- 统计卡片 -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0" id="totalPaymentAccounts">0</h4>
                                            <p class="mb-0">总账户数</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-credit-card fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0" id="activePaymentAccounts">0</h4>
                                            <p class="mb-0">启用账户</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-check-circle fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0" id="inactivePaymentAccounts">0</h4>
                                            <p class="mb-0">禁用账户</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-times-circle fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="mb-0" id="defaultPaymentAccounts">0</h4>
                                            <p class="mb-0">默认账户</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-star fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 收款账户管理卡片 -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-credit-card text-primary"></i> 收款账户管理</h5>
                            <button class="btn btn-success" onclick="showAddPaymentAccountModal()">
                                <i class="fas fa-plus"></i> 添加收款账户
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- 操作按钮和搜索区域 -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <select class="form-control" id="paymentAccountStatusFilter" onchange="searchPaymentAccounts()">
                                        <option value="">全部状态</option>
                                        <option value="enabled">启用</option>
                                        <option value="disabled">禁用</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="paymentAccountSearch" placeholder="搜索账户名称或地址" onkeyup="searchPaymentAccounts()">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary" onclick="searchPaymentAccounts()">
                                        <i class="fas fa-search"></i> 搜索
                                    </button>
                                </div>
                                <div class="col-md-2 ms-auto">
                                    <button class="btn btn-info" onclick="loadPaymentAccounts()">
                                        <i class="fas fa-sync-alt"></i> 刷新
                                    </button>
                                </div>
                            </div>

                            <!-- 收款账户表格 -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>钱包名称</th>
                                            <th>数字货币</th>
                                            <th>网络类型</th>
                                            <th>钱包地址</th>
                                            <th>账户标识</th>
                                            <th>状态</th>
                                            <th>默认</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentAccountsTableBody">
                                        <tr>
                                            <td colspan="9" class="text-center text-muted">
                                                <div class="loading"></div>
                                                正在加载收款账户列表...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // 全局变量
        let currentSection = 'website-settings';
        let currentCategory = 'basic-info';
        
        // API基础URL配置
        const API_BASE_URL = 'http://localhost:5065';

        // 菜单配置数据
        const menuConfig = {
            'website-settings': {
                name: '网站设置',
                categories: [
                    { id: 'basic-info', name: '基础信息设置' },
                    { id: 'slideshow', name: '轮播图管理' },
                    { id: 'country-codes', name: '手机区号管理' },
                    { id: 'vip-levels', name: 'VIP等级管理' }
                ]
            },
            'member-management': {
                name: '会员管理',
                categories: [
                    { id: 'member-list', name: '会员列表' },
                    { id: 'staff-list', name: '业务员管理' }
                ]
            },
            'order-management': {
                name: '订单管理',
                categories: [
                    { id: 'order-list', name: '订单列表' },
                    { id: 'order-details', name: '订单详情' }
                ]
            },
            'payment-management': {
                name: '收款管理',
                categories: [
                    { id: 'payment-accounts', name: '收款账户管理' }
                ]
            }
        };

        // 临时修复localStorage中的用户ID不一致问题
        function fixUserIdInLocalStorage() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (currentUser.id === 'super_001') {
                currentUser.id = '1';  // 修改为与users.json一致的ID
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('已修复localStorage中的用户ID:', currentUser);
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 修复用户ID不一致问题
            fixUserIdInLocalStorage();
            
            // 首先检查权限
            checkUserPermissions();
            
            initializeNavigation();
            showMainSection(currentSection);
            loadSlideshowList(); // 加载轮播图列表
            loadVipLevels(); // 加载VIP等级列表
            loadStaffList(); // 加载业务员列表
            loadPaymentAccounts(); // 加载收款账户列表
            initializeFormEventListeners(); // 初始化表单事件监听器
            
            // 添加搜索框回车键监听
            const searchStaffInput = document.getElementById('searchStaff');
            if (searchStaffInput) {
                searchStaffInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchStaff();
                    }
                });
            }
            
            // 添加收款账户搜索框回车键监听
            const searchPaymentAccountsInput = document.getElementById('searchPaymentAccounts');
            if (searchPaymentAccountsInput) {
                searchPaymentAccountsInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchPaymentAccounts();
                    }
                });
            }
        });

        // 初始化导航
        function initializeNavigation() {
            // 主菜单点击事件
            document.querySelectorAll('.nav-link[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showMainSection(section);
                });
            });
        }

        // 显示主菜单对应的内容
        function showMainSection(section) {
            // 更新当前选中的主菜单
            currentSection = section;
            
            // 移除所有主菜单的active状态
            document.querySelectorAll('.nav-link[data-section]').forEach(link => {
                link.classList.remove('active');
            });

            // 激活当前主菜单
            const activeMainLink = document.querySelector(`[data-section="${section}"]`);
            if (activeMainLink) {
                activeMainLink.classList.add('active');
            }

            // 生成分类菜单
            generateCategoryMenu(section);
            
            // 显示第一个有权限的分类的内容
            const availableCategories = getAvailableCategories(section);
            if (availableCategories.length > 0) {
                showCategory(availableCategories[0].id);
            }

            // 更新面包屑
            updateBreadcrumb();
        }

        // 获取有权限的分类列表
        function getAvailableCategories(section) {
            const config = menuConfig[section];
            if (!config) return [];
            
            return config.categories.filter(category => {
                // 所有分类都可访问（收款账户管理和管理员设置已移除）
                return true;
            });
        }

        // 生成分类菜单
        function generateCategoryMenu(section) {
            const categoryNav = document.getElementById('category-nav');
            
            if (!categoryNav) return;

            // 清空现有菜单
            categoryNav.innerHTML = '';

            // 获取有权限的分类并生成菜单项
            const availableCategories = getAvailableCategories(section);
            availableCategories.forEach(category => {
                const li = document.createElement('li');
                li.className = 'nav-item';
                
                const a = document.createElement('a');
                a.className = 'nav-link';
                a.href = '#';
                a.textContent = category.name;
                a.setAttribute('data-category', category.id);
                
                // 添加点击事件
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    showCategory(category.id);
                });

                li.appendChild(a);
                categoryNav.appendChild(li);
            });
        }

        // 显示分类内容
        function showCategory(categoryId) {
            currentCategory = categoryId;

            // 移除所有分类菜单的active状态
            document.querySelectorAll('.category-nav .nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // 激活当前分类菜单
            const activeCategoryLink = document.querySelector(`[data-category="${categoryId}"]`);
            if (activeCategoryLink) {
                activeCategoryLink.classList.add('active');
            }

            // 显示对应内容区域
            showContentSection(categoryId);

            // 更新面包屑
            updateBreadcrumb();
        }

        // 显示内容区域
        function showContentSection(contentId) {
            // 隐藏所有内容区域
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // 显示指定内容区域
            const targetSection = document.getElementById(contentId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
        }

        // 更新面包屑导航
        function updateBreadcrumb() {
            const pageTitle = document.getElementById('page-title');
            const sectionBreadcrumb = document.getElementById('section-breadcrumb');

            const sectionConfig = menuConfig[currentSection];
            if (sectionConfig) {
                if (pageTitle) pageTitle.textContent = sectionConfig.name;
                if (sectionBreadcrumb) sectionBreadcrumb.textContent = sectionConfig.name;
            }
        }

        // 返回首页
        function goToHome() {
            if (confirm('确定要返回首页吗？')) {
                window.location.href = 'home.html';
            }
        }

        // 退出登录
        function logout() {
            Swal.fire({
                title: '确定要退出登录吗？',
                text: '退出后需要重新登录',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '确定退出',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 清除登录状态
                    localStorage.removeItem('adminToken');
                    sessionStorage.clear();
                    
                    Swal.fire({
                        title: '退出成功',
                        text: '正在跳转到登录页面...',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = 'admin-login.html';
                    });
                }
            });
        }

        // 加载业务员列表
        async function loadStaffList() {
            try {
                console.log('开始加载业务员列表...');
                const response = await fetch(`${API_BASE_URL}/api/salesperson/list`);
                
                console.log('API响应状态:', response.status, response.statusText);
                
                if (response.ok) {
                    // 检查响应是否为空
                    const responseText = await response.text();
                    console.log('API响应内容:', responseText);
                    
                    if (!responseText || responseText.trim() === '') {
                        console.warn('API返回空响应');
                        staffData = [];
                        renderStaffTable();
                        updateStaffStats();
                        return;
                    }
                    
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (jsonError) {
                        console.error('JSON解析失败:', jsonError);
                        console.error('响应内容:', responseText);
                        throw new Error('服务器返回的数据格式不正确');
                    }
                    
                    if (result && result.success) {
                        // 映射后端的 Status 字段到前端的 isActive 字段
                        staffData = (result.data || []).map(staff => ({
                            ...staff,
                            isActive: staff.status === 'active'
                        }));
                        console.log('成功加载业务员数据:', staffData.length, '个业务员');
                        renderStaffTable();
                        updateStaffStats();
                    } else {
                        console.error('API返回错误:', result);
                        throw new Error(result?.message || '获取业务员列表失败');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('API请求失败:', response.status, errorText);
                    throw new Error(`网络请求失败: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('加载业务员列表失败:', error);
                
                // 设置默认空数据
                staffData = [];
                
                // 显示错误信息
                document.getElementById('staffTableBody').innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i> 加载失败: ${error.message}
                            <br><small class="text-muted">请检查网络连接或联系管理员</small>
                        </td>
                    </tr>
                `;
                
                // 更新统计数据为0
                updateStaffStats();
            }
        }

        // 更新业务员统计数据
        function updateStaffStats() {
            const totalStaff = staffData.length;
            const activeStaff = staffData.filter(staff => staff.isActive).length;
            const inactiveStaff = staffData.filter(staff => !staff.isActive).length;
            const totalCustomers = staffData.reduce((sum, staff) => sum + (staff.customerCount || 0), 0);
            
            // 更新页面上的统计显示
            const totalStaffElement = document.getElementById('totalStaff');
            const activeStaffElement = document.getElementById('activeStaff');
            const inactiveStaffElement = document.getElementById('inactiveStaff');
            const totalCustomersElement = document.getElementById('totalCustomers');
            
            if (totalStaffElement) totalStaffElement.textContent = totalStaff;
            if (activeStaffElement) activeStaffElement.textContent = activeStaff;
            if (inactiveStaffElement) inactiveStaffElement.textContent = inactiveStaff;
            if (totalCustomersElement) totalCustomersElement.textContent = totalCustomers;
            
            console.log(`统计更新: 总业务员 ${totalStaff}, 活跃业务员 ${activeStaff}, 禁用业务员 ${inactiveStaff}, 总客户 ${totalCustomers}`);
        }

        // 渲染业务员表格
        function renderStaffTable() {
            const tbody = document.getElementById('staffTableBody');
            
            if (staffData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-users"></i> 暂无业务员数据
                            <br><small class="text-muted">当前业务员数量: 0</small>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = staffData.map(staff => {
                // 显示账号（优先显示用户名）
                const account = staff.username || '-';
                
                // 显示密码（注意：实际项目中不应该显示明文密码，这里按用户要求显示）
                // 优先显示明文密码
                const password = staff.plainPassword || staff.PlainPassword || staff.passwordHash || staff.PasswordHash || staff.password || staff.Password || '未设置';
                
                // 显示邀请码
                const inviteCode = staff.inviteCode || '-';
                
                // 客户数
                const customerCount = staff.customerCount || 0;
                
                // 创建时间
                const createdAt = formatDateTime(staff.createdAt);
                
                return `
                    <tr>
                        <td><strong>${account}</strong></td>
                        <td><span class="text-danger">${password}</span></td>
                        <td>
                            <span class="badge bg-primary">${inviteCode}</span>
                        </td>
                        <td>
                            <span class="badge bg-info">${customerCount}</span>
                        </td>
                        <td>${createdAt}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" onclick="showEditStaffModal('${staff.id}')" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-${staff.isActive ? 'warning' : 'success'}" 
                                        onclick="toggleStaffStatus('${staff.id}')" 
                                        title="${staff.isActive ? '禁用' : '启用'}">
                                    <i class="fas fa-${staff.isActive ? 'ban' : 'check'}"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="showStaffCustomers('${staff.id}')" title="查看客户">
                                    <i class="fas fa-users"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="showTransferCustomersOnly('${staff.id}')" title="转移客户">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteStaff('${staff.id}')" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 搜索业务员
        function searchStaff() {
            const searchTerm = document.getElementById('searchStaff').value.toLowerCase();
            const statusFilter = document.getElementById('filterStaffStatus').value;

            let filteredData = staffData;

            // 按搜索词过滤
            if (searchTerm) {
                filteredData = filteredData.filter(staff => 
                    (staff.nickname || '').toLowerCase().includes(searchTerm) ||
                    (staff.username || '').toLowerCase().includes(searchTerm) ||
                    (staff.inviteCode || '').toLowerCase().includes(searchTerm)
                );
            }

            // 按状态过滤
            if (statusFilter !== '') {
                const isActive = statusFilter === 'active';
                filteredData = filteredData.filter(staff => staff.isActive === isActive);
            }

            // 临时更新数据并重新渲染
            const originalData = staffData;
            staffData = filteredData;
            renderStaffTable();
            staffData = originalData;
        }

        // ==================== 收款账户管理功能 ====================
        
        // 收款账户数据
        let paymentAccountsData = [];

        // 加载收款账户列表
        async function loadPaymentAccounts() {
            try {
                console.log('开始加载收款账户列表...');
                
                // 获取当前用户信息
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userId = currentUser.id || currentUser.Id || '';
                
                console.log('localStorage currentUser:', localStorage.getItem('currentUser'));
                console.log('解析后的用户信息:', currentUser);
                console.log('当前用户ID:', userId);
                
                const url = userId ? 
                    `${API_BASE_URL}/api/admin/payment-accounts?userId=${encodeURIComponent(userId)}` : 
                    `${API_BASE_URL}/api/admin/payment-accounts`;
                    
                console.log('请求URL:', url);
                console.log('API_BASE_URL:', API_BASE_URL);
                
                const response = await fetch(url);
                
                console.log('响应状态:', response.status, response.statusText);
                console.log('响应头:', [...response.headers.entries()]);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('响应数据:', result);
                    if (result && result.success) {
                        paymentAccountsData = result.data || [];
                        console.log('成功加载收款账户数据:', paymentAccountsData.length, '个账户');
                        renderPaymentAccountsTable();
                        updatePaymentAccountStats();
                    } else {
                        throw new Error(result?.message || '获取收款账户列表失败');
                    }
                } else {
                    const errorText = await response.text();
                    console.log('错误响应内容:', errorText);
                    throw new Error(`网络请求失败: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('加载收款账户列表失败:', error);
                
                // 设置默认空数据
                paymentAccountsData = [];
                
                // 显示错误信息
                document.getElementById('paymentAccountsTableBody').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i> 加载失败: ${error.message}
                            <br><small class="text-muted">请检查网络连接或联系管理员</small>
                        </td>
                    </tr>
                `;
                
                // 更新统计数据为0
                updatePaymentAccountStats();
            }
        }

        // 渲染收款账户表格
        function renderPaymentAccountsTable() {
            const tbody = document.getElementById('paymentAccountsTableBody');
            
            if (paymentAccountsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            <i class="fas fa-credit-card"></i> 暂无收款账户数据
                            <br><small class="text-muted">点击"添加收款账户"按钮开始添加</small>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = paymentAccountsData.map(account => `
                <tr>
                    <td>${account.walletName || '-'}</td>
                    <td>
                        <span class="badge bg-info">${getCryptoCurrencyText(account.accountType)}</span>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${getNetworkTypeText(account.networkType)}</span>
                    </td>
                    <td>
                        <code class="text-primary">${formatWalletAddress(account.accountNumber)}</code>
                    </td>
                    <td>${account.accountIdentifier || '-'}</td>
                    <td>
                        <span class="status-badge ${account.status === 'enabled' ? 'status-active' : 'status-inactive'}">
                            ${account.status === 'enabled' ? '启用' : '禁用'}
                        </span>
                    </td>
                    <td>
                        ${account.isDefault ? '<i class="fas fa-star text-warning" title="默认账户"></i>' : '-'}
                    </td>
                    <td>${formatDateTime(account.createdAt)}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="editPaymentAccount('${account.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deletePaymentAccount('${account.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 更新收款账户统计数据
        function updatePaymentAccountStats() {
            const total = paymentAccountsData.length;
            const active = paymentAccountsData.filter(account => account.status === 'enabled').length;
            const inactive = paymentAccountsData.filter(account => account.status === 'disabled').length;
            const defaultAccounts = paymentAccountsData.filter(account => account.isDefault).length;
            
            // 更新页面上的统计显示
            const totalElement = document.getElementById('totalPaymentAccounts');
            const activeElement = document.getElementById('activePaymentAccounts');
            const inactiveElement = document.getElementById('inactivePaymentAccounts');
            const defaultElement = document.getElementById('defaultPaymentAccounts');
            
            if (totalElement) totalElement.textContent = total;
            if (activeElement) activeElement.textContent = active;
            if (inactiveElement) inactiveElement.textContent = inactive;
            if (defaultElement) defaultElement.textContent = defaultAccounts;
            
            console.log(`收款账户统计更新: 总账户 ${total}, 启用 ${active}, 禁用 ${inactive}, 默认 ${defaultAccounts}`);
        }

        // 搜索收款账户
        function searchPaymentAccounts() {
            const searchTerm = document.getElementById('paymentAccountSearch').value.toLowerCase();
            const statusFilter = document.getElementById('paymentAccountStatusFilter').value;

            let filteredData = paymentAccountsData;

            // 按搜索词过滤
            if (searchTerm) {
                filteredData = filteredData.filter(account => 
                    (account.walletName || '').toLowerCase().includes(searchTerm) ||
                    (account.accountNumber || '').toLowerCase().includes(searchTerm) ||
                    (account.accountIdentifier || '').toLowerCase().includes(searchTerm)
                );
            }

            // 按状态过滤
            if (statusFilter) {
                filteredData = filteredData.filter(account => account.status === statusFilter);
            }

            // 临时更新数据并重新渲染
            const originalData = paymentAccountsData;
            paymentAccountsData = filteredData;
            renderPaymentAccountsTable();
            paymentAccountsData = originalData;
        }

        // 显示添加收款账户模态框
        function showAddPaymentAccountModal() {
            // 重置表单
            document.getElementById('paymentAccountForm').reset();
            document.getElementById('paymentAccountId').value = '';
            
            // 显示添加标题，隐藏编辑标题
            document.getElementById('addPaymentAccountTitle').style.display = 'inline';
            document.getElementById('editPaymentAccountTitle').style.display = 'none';
            
            // 重置网络类型选项
            document.getElementById('networkType').innerHTML = '<option value="">请先选择数字货币类型</option>';
            
            // 重置地址格式提示
            document.getElementById('addressFormatHint').textContent = '请输入有效的钱包地址';
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('paymentAccountModal'));
            modal.show();
        }

        // 编辑收款账户
        function editPaymentAccount(accountId) {
            const account = paymentAccountsData.find(a => a.id === accountId);
            if (!account) {
                Swal.fire({
                    title: '错误',
                    text: '收款账户不存在',
                    icon: 'error'
                });
                return;
            }

            // 填充表单数据
            document.getElementById('paymentAccountId').value = account.id;
            document.getElementById('walletName').value = account.walletName || '';
            document.getElementById('accountType').value = account.accountType || '';
            document.getElementById('accountNumber').value = account.accountNumber || '';
            document.getElementById('accountIdentifier').value = account.accountIdentifier || '';
            document.getElementById('accountStatus').value = account.status || 'enabled';
            document.getElementById('isDefault').checked = account.isDefault || false;
            document.getElementById('remarks').value = account.remarks || '';
            
            // 更新网络类型选项
            updateNetworkOptions();
            document.getElementById('networkType').value = account.networkType || '';
            
            // 更新地址格式提示
            updateAddressFormatHint();
            
            // 显示编辑标题，隐藏添加标题
            document.getElementById('addPaymentAccountTitle').style.display = 'none';
            document.getElementById('editPaymentAccountTitle').style.display = 'inline';
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('paymentAccountModal'));
            modal.show();
        }

        // 保存收款账户
        async function savePaymentAccount() {
            const form = document.getElementById('paymentAccountForm');
            const formData = new FormData(form);
            
            // 验证必填字段
            const walletName = formData.get('walletName');
            const accountType = formData.get('accountType');
            const networkType = formData.get('networkType');
            const accountNumber = formData.get('accountNumber');
            const status = formData.get('status');
            
            if (!walletName || !accountType || !networkType || !accountNumber || !status) {
                Swal.fire({
                    title: '请填写必填字段',
                    text: '钱包名称、数字货币类型、网络类型、钱包地址和状态为必填项',
                    icon: 'warning'
                });
                return;
            }
            
            // 验证钱包地址格式
            if (!validateWalletAddress(accountNumber, accountType)) {
                Swal.fire({
                    title: '钱包地址格式不正确',
                    text: '请输入有效的钱包地址',
                    icon: 'warning'
                });
                return;
            }
            
            // 构建请求数据
            const accountData = {
                walletName: walletName,
                accountType: accountType,
                networkType: networkType,
                accountNumber: accountNumber,
                accountIdentifier: formData.get('accountIdentifier') || '',
                status: status,
                isDefault: formData.get('isDefault') === 'on',
                remarks: formData.get('remarks') || ''
            };
            
            const accountId = formData.get('id');
            const isEdit = accountId && accountId !== '';
            
            try {
                Swal.fire({
                    title: isEdit ? '正在更新收款账户' : '正在添加收款账户',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // 获取当前用户信息
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userId = currentUser.id || currentUser.Id || '';
                
                const baseUrl = isEdit ? 
                    `${API_BASE_URL}/api/admin/payment-accounts/${accountId}` : 
                    `${API_BASE_URL}/api/admin/payment-accounts`;
                const url = userId ? `${baseUrl}?userId=${encodeURIComponent(userId)}` : baseUrl;
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(accountData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || (isEdit ? '更新失败' : '添加失败'));
                }
                
                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('paymentAccountModal')).hide();
                
                // 重新加载收款账户列表
                await loadPaymentAccounts();
                
                Swal.fire({
                    title: isEdit ? '更新成功' : '添加成功',
                    text: `收款账户 "${walletName}" ${isEdit ? '已更新' : '已添加'}`,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
            } catch (error) {
                console.error('保存收款账户失败:', error);
                Swal.fire({
                    title: isEdit ? '更新失败' : '添加失败',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // 删除收款账户
        function deletePaymentAccount(accountId) {
            const account = paymentAccountsData.find(a => a.id === accountId);
            if (!account) {
                Swal.fire({
                    title: '错误',
                    text: '收款账户不存在',
                    icon: 'error'
                });
                return;
            }

            Swal.fire({
                title: '确认删除',
                html: `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <p>确定要删除收款账户 <strong>"${account.walletName}"</strong> 吗？</p>
                        <p class="text-muted">此操作不可撤销</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '确定删除',
                cancelButtonText: '取消'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        Swal.fire({
                            title: '正在删除收款账户',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        // 获取当前用户信息
                        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                        const userId = currentUser.id || currentUser.Id || '';
                        
                        const baseUrl = `${API_BASE_URL}/api/admin/payment-accounts/${accountId}`;
                        const url = userId ? `${baseUrl}?userId=${encodeURIComponent(userId)}` : baseUrl;
                        
                        const response = await fetch(url, {
                            method: 'DELETE'
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.message || '删除失败');
                        }

                        // 重新加载收款账户列表
                        await loadPaymentAccounts();

                        Swal.fire({
                            title: '删除成功',
                            text: `收款账户 "${account.walletName}" 已删除`,
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });

                    } catch (error) {
                        console.error('删除收款账户失败:', error);
                        Swal.fire({
                            title: '删除失败',
                            text: error.message,
                            icon: 'error'
                        });
                    }
                }
            });
        }

        // 切换业务员状态
        function toggleStaffStatus(staffId) {
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) {
                Swal.fire({
                    title: '错误',
                    text: '业务员不存在',
                    icon: 'error'
                });
                return;
            }

            const newStatus = !staff.isActive;
            const actionText = newStatus ? '启用' : '禁用';

            Swal.fire({
                title: `确认${actionText}`,
                html: `
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="fas fa-user-tie fa-3x text-primary"></i>
                        </div>
                        <p><strong>${staff.name}</strong></p>
                        <p class="text-muted">账号: ${staff.username}</p>
                        <p>确定要${actionText}这个业务员吗？</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: `确定${actionText}`,
                cancelButtonText: '取消',
                confirmButtonColor: newStatus ? '#28a745' : '#ffc107'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        Swal.fire({
                            title: `${actionText}中...`,
                            text: `正在${actionText}业务员`,
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const response = await fetch(`${API_BASE_URL}/api/salesperson/update/${staffId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: staff.name,
                                phone: staff.phone,
                                email: staff.email,
                                department: staff.department,
                                inviteCode: staff.inviteCode,
                                status: newStatus ? 'active' : 'inactive'
                            })
                        });

                        let result = { success: false, message: '响应解析失败' };
                        try {
                            const responseText = await response.text();
                            if (responseText.trim()) {
                                result = JSON.parse(responseText);
                            }
                        } catch (error) {
                            console.error('解析状态更新响应JSON失败:', error);
                            throw new Error('服务器响应格式错误');
                        }

                        if (response.ok && result.success) {
                            await loadStaffList();
                            Swal.fire({
                                title: `${actionText}成功`,
                                text: `业务员已${actionText}`,
                                icon: 'success',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            throw new Error(result.message || `${actionText}失败`);
                        }
                    } catch (error) {
                        console.error(`${actionText}业务员失败:`, error);
                        Swal.fire({
                            title: `${actionText}失败`,
                            text: error.message,
                            icon: 'error'
                        });
                    }
                }
            });
        }

        // 删除业务员
        async function deleteStaff(staffId) {
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) {
                Swal.fire({
                    title: '错误',
                    text: '业务员不存在',
                    icon: 'error'
                });
                return;
            }

            // 第一次确认 - 显示业务员信息和警告
            Swal.fire({
                title: '确认删除业务员',
                html: `
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        </div>
                        <p><strong>业务员信息：</strong></p>
                        <p>ID: <span class="badge bg-light text-dark">${staff.id}</span></p>
                        <p>账号: <strong>${staff.username || '未设置'}</strong></p>
                        <p>昵称: <strong>${staff.nickname || '未设置'}</strong></p>
                        <p>邀请码: <strong>${staff.inviteCode || '未设置'}</strong></p>
                        <p>状态: <span class="badge ${staff.isActive ? 'bg-success' : 'bg-secondary'}">${staff.isActive ? '活跃' : '非活跃'}</span></p>
                        <div class="alert alert-warning mt-3">
                            <strong>注意：</strong>删除业务员可能会影响相关客户数据！<br>
                            如果该业务员有客户，系统会要求转移客户。
                        </div>
                        <p class="text-danger">确定要删除这个业务员吗？</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '确认删除',
                cancelButtonText: '取消',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // 第二次确认 - 最终确认
                    Swal.fire({
                        title: '最终确认',
                        html: `
                            <div class="text-center">
                                <div class="mb-3">
                                    <i class="fas fa-exclamation-circle text-danger" style="font-size: 3rem;"></i>
                                </div>
                                <p class="text-danger"><strong>这是最后一次确认！</strong></p>
                                <p>您即将删除业务员：<strong>${staff.nickname || staff.username}</strong></p>
                                <div class="alert alert-danger mt-3">
                                    <strong>警告：</strong>此操作无法撤销！
                                </div>
                                <p>确定要继续吗？</p>
                            </div>
                        `,
                        icon: 'error',
                        showCancelButton: true,
                        confirmButtonText: '确定删除',
                        cancelButtonText: '取消',
                        confirmButtonColor: '#dc3545',
                        cancelButtonColor: '#6c757d'
                    }).then(async (finalResult) => {
                        if (finalResult.isConfirmed) {
                            await performStaffDeletion(staffId);
                        }
                    });
                }
            });
        }

        // 执行业务员删除操作
        async function performStaffDeletion(staffId) {
            try {
                Swal.fire({
                    title: '删除中...',
                    text: '正在删除业务员',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 先尝试删除，检查是否有客户
                const response = await fetch(`${API_BASE_URL}/api/salesperson/delete/${staffId}`, {
                    method: 'DELETE'
                });

                let result = { success: false, message: '响应解析失败' };
                try {
                    const responseText = await response.text();
                    if (responseText.trim()) {
                        result = JSON.parse(responseText);
                    }
                } catch (error) {
                    console.error('解析删除响应JSON失败:', error);
                    throw new Error('服务器响应格式错误');
                }

                if (response.ok) {
                    // 删除成功
                    await loadStaffList();
                    Swal.fire({
                        title: '删除成功',
                        text: '业务员已成功删除',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else if (result.hasCustomers) {
                    // 有客户需要转移
                    showTransferCustomersDialog(result);
                } else {
                    throw new Error(result.message || '删除失败');
                }
            } catch (error) {
                console.error('删除业务员失败:', error);
                Swal.fire({
                    title: '删除失败',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // 显示客户转移对话框
        async function showTransferCustomersDialog(deleteResult) {
            const { salesperson, customers, customerCount } = deleteResult;
            
            // 获取其他业务员列表（排除当前要删除的业务员）
            const otherStaff = staffData.filter(s => s.id !== salesperson.id && s.isActive);
            
            if (otherStaff.length === 0) {
                Swal.fire({
                    title: '无法删除',
                    text: '没有其他可用的业务员来接收客户，请先添加其他业务员',
                    icon: 'warning'
                });
                return;
            }

            const staffOptions = otherStaff.map(s => 
                `<option value="${s.id}">${s.nickname} (${s.username}) - 邀请码: ${s.inviteCode}</option>`
            ).join('');

            const customerList = customers.map(c => 
                `<tr>
                    <td>${c.username}</td>
                    <td>${c.email}</td>
                    <td><span class="badge bg-secondary">${c.inviteCode}</span></td>
                </tr>`
            ).join('');

            const { value: targetStaffId } = await Swal.fire({
                title: '客户转移',
                html: `
                    <div class="text-start">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            业务员 <strong>${salesperson.nickname}</strong> 还有 <strong>${customerCount}</strong> 个客户，需要先转移客户才能删除。
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">选择目标业务员：</label>
                            <select id="targetStaff" class="form-select">
                                <option value="">请选择业务员</option>
                                ${staffOptions}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">客户列表预览：</label>
                            <div style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>用户名</th>
                                            <th>邮箱</th>
                                            <th>当前邀请码</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${customerList}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            转移后，所有客户的邀请码将更新为目标业务员的邀请码。
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '确认转移并删除',
                cancelButtonText: '取消',
                confirmButtonColor: '#dc3545',
                width: '600px',
                preConfirm: () => {
                    const targetStaffId = document.getElementById('targetStaff').value;
                    if (!targetStaffId) {
                        Swal.showValidationMessage('请选择目标业务员');
                        return false;
                    }
                    return targetStaffId;
                }
            });

            if (targetStaffId) {
                await transferAndDeleteStaff(salesperson.id, targetStaffId);
            }
        }

        // 转移客户并删除业务员
        async function transferAndDeleteStaff(sourceStaffId, targetStaffId) {
            try {
                Swal.fire({
                    title: '转移中...',
                    text: '正在转移客户并删除业务员',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 1. 转移客户
                const transferResponse = await fetch(`${API_BASE_URL}/api/salesperson/transfer-customers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sourceSalespersonId: sourceStaffId,
                        targetSalespersonId: targetStaffId
                    })
                });

                let transferResult = { success: false, message: '转移响应解析失败' };
                try {
                    const transferText = await transferResponse.text();
                    if (transferText.trim()) {
                        transferResult = JSON.parse(transferText);
                    }
                } catch (error) {
                    console.error('解析转移响应JSON失败:', error);
                    throw new Error('转移响应格式错误');
                }

                if (!transferResponse.ok) {
                    throw new Error(transferResult.message || '客户转移失败');
                }

                // 2. 强制删除业务员
                const deleteResponse = await fetch(`${API_BASE_URL}/api/salesperson/delete/${sourceStaffId}?force=true`, {
                    method: 'DELETE'
                });

                let deleteResult = { success: false, message: '删除响应解析失败' };
                try {
                    const deleteText = await deleteResponse.text();
                    if (deleteText.trim()) {
                        deleteResult = JSON.parse(deleteText);
                    }
                } catch (error) {
                    console.error('解析删除响应JSON失败:', error);
                    throw new Error('删除响应格式错误');
                }

                if (!deleteResponse.ok) {
                    throw new Error(deleteResult.message || '删除业务员失败');
                }

                // 3. 刷新列表
                await loadStaffList();

                Swal.fire({
                    title: '操作成功',
                    html: `
                        <div class="text-center">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <p>已成功转移 <strong>${transferResult.transferredCount}</strong> 个客户到业务员 <strong>${transferResult.targetSalesperson.nickname}</strong></p>
                            <p>业务员已删除</p>
                        </div>
                    `,
                    icon: 'success',
                    timer: 3000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('转移和删除操作失败:', error);
                Swal.fire({
                    title: '操作失败',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // 显示独立的客户转移对话框（不删除业务员）
        async function showTransferCustomersOnly(staffId) {
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) {
                Swal.fire({
                    title: '错误',
                    text: '业务员不存在',
                    icon: 'error'
                });
                return;
            }

            try {
                // 获取该业务员的客户列表
                const response = await fetch(`${API_BASE_URL}/api/salesperson/customers/${staffId}`);
                
                if (!response.ok) {
                    throw new Error('获取客户列表失败');
                }
                
                let customers = [];
                try {
                    const responseText = await response.text();
                    if (responseText.trim()) {
                        const data = JSON.parse(responseText);
                        // 正确解析API返回的数据格式
                        customers = data.customers || [];
                    }
                } catch (error) {
                    console.error('解析客户列表JSON失败:', error);
                    customers = [];
                }

                if (!customers || customers.length === 0) {
                    Swal.fire({
                        title: '提示',
                        text: '该业务员没有分配的客户',
                        icon: 'info'
                    });
                    return;
                }

                // 获取其他业务员列表（排除当前业务员）
                const otherStaff = staffData.filter(s => s.id !== staffId && s.isActive);
                
                if (otherStaff.length === 0) {
                    Swal.fire({
                        title: '无法转移',
                        text: '没有其他可用的业务员来接收客户',
                        icon: 'warning'
                    });
                    return;
                }

                const staffOptions = otherStaff.map(s => 
                    `<option value="${s.id}">${s.nickname} (${s.username}) - 邀请码: ${s.inviteCode}</option>`
                ).join('');

                const customerList = customers.map(c => 
                    `<tr>
                        <td>${c.username}</td>
                        <td>${c.email}</td>
                        <td><span class="badge bg-secondary">${c.inviteCode}</span></td>
                    </tr>`
                ).join('');

                const { value: targetStaffId } = await Swal.fire({
                    title: '转移客户',
                    html: `
                        <div class="text-start">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                将业务员 <strong>${staff.nickname}</strong> 的 <strong>${customers.length}</strong> 个客户转移给其他业务员。
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">选择目标业务员：</label>
                                <select id="targetStaffTransfer" class="form-select">
                                    <option value="">请选择业务员</option>
                                    ${staffOptions}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">客户列表：</label>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>用户名</th>
                                                <th>邮箱</th>
                                                <th>当前邀请码</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${customerList}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                转移后，所有客户的邀请码将更新为目标业务员的邀请码。
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: '确认转移',
                    cancelButtonText: '取消',
                    confirmButtonColor: '#007bff',
                    width: '600px',
                    preConfirm: () => {
                        const targetStaffId = document.getElementById('targetStaffTransfer').value;
                        if (!targetStaffId) {
                            Swal.showValidationMessage('请选择目标业务员');
                            return false;
                        }
                        return targetStaffId;
                    }
                });

                if (targetStaffId) {
                    await transferCustomersOnly(staffId, targetStaffId);
                }

            } catch (error) {
                console.error('获取客户列表失败:', error);
                Swal.fire({
                    title: '错误',
                    text: '获取客户列表失败',
                    icon: 'error'
                });
            }
        }

        // 仅转移客户（不删除业务员）
        async function transferCustomersOnly(sourceStaffId, targetStaffId) {
            try {
                Swal.fire({
                    title: '转移中...',
                    text: '正在转移客户',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const transferResponse = await fetch(`${API_BASE_URL}/api/salesperson/transfer-customers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sourceSalespersonId: sourceStaffId,
                        targetSalespersonId: targetStaffId
                    })
                });

                const transferResult = await transferResponse.json();

                if (!transferResponse.ok) {
                    throw new Error(transferResult.message || '客户转移失败');
                }

                // 刷新列表
                await loadStaffList();

                Swal.fire({
                    title: '转移成功',
                    html: `
                        <div class="text-center">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <p>已成功转移 <strong>${transferResult.transferredCount}</strong> 个客户到业务员 <strong>${transferResult.targetSalesperson.nickname}</strong></p>
                        </div>
                    `,
                    icon: 'success',
                    timer: 3000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('客户转移失败:', error);
                Swal.fire({
                    title: '转移失败',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // 客户列表相关变量
        let currentStaffId = null;
        let allCustomers = [];
        let filteredCustomers = [];
        let selectedCustomers = [];
        let currentPage = 1;
        const customersPerPage = 10;

        // 显示业务员客户列表
        async function showStaffCustomers(staffId) {
            currentStaffId = staffId;
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) {
                Swal.fire({
                    title: '错误',
                    text: '业务员不存在',
                    icon: 'error'
                });
                return;
            }

            // 更新模态框标题
            document.getElementById('staffCustomersModalLabel').textContent = `${staff.nickname} 的客户列表`;

            try {
                // 显示加载状态
                document.getElementById('customersTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <div class="mt-2">正在加载客户数据...</div>
                        </td>
                    </tr>
                `;

                // 获取客户列表
                const response = await fetch(`${API_BASE_URL}/api/salesperson/customers/${staffId}`);
                
                if (!response.ok) {
                    throw new Error('获取客户列表失败');
                }
                
                let customers = [];
                try {
                    const responseText = await response.text();
                    if (responseText.trim()) {
                        const data = JSON.parse(responseText);
                        // 正确解析API返回的数据格式
                        customers = data.customers || [];
                    }
                } catch (error) {
                    console.error('解析客户列表JSON失败:', error);
                    customers = [];
                }

                allCustomers = customers || [];
                filteredCustomers = [...allCustomers];
                selectedCustomers = [];
                currentPage = 1;

                // 更新客户数量
                updateCustomerCount();

                // 渲染客户列表
                renderCustomersList();

                // 加载业务员列表用于转移
                await loadSalespersonOptions();

                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('staffCustomersModal'));
                modal.show();

            } catch (error) {
                console.error('获取客户列表失败:', error);
                Swal.fire({
                    title: '获取失败',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // 渲染客户列表
        function renderCustomersList() {
            const tbody = document.getElementById('customersTableBody');
            
            if (filteredCustomers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <div>暂无客户数据</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // 计算分页
            const startIndex = (currentPage - 1) * customersPerPage;
            const endIndex = startIndex + customersPerPage;
            const pageCustomers = filteredCustomers.slice(startIndex, endIndex);

            tbody.innerHTML = pageCustomers.map(customer => `
                <tr>
                    <td>
                        <input type="checkbox" class="customer-checkbox" value="${customer.id}" 
                               onchange="toggleCustomerSelection('${customer.id}')">
                    </td>
                    <td>${customer.username || '-'}</td>
                    <td>${customer.nickname || '-'}</td>
                    <td>${customer.email || '-'}</td>
                    <td>
                        <code class="text-primary">${customer.inviteCode || '-'}</code>
                    </td>
                    <td>
                        <span class="badge ${customer.isActive ? 'bg-success' : 'bg-secondary'}">
                            ${customer.isActive ? '正常' : '禁用'}
                        </span>
                    </td>
                    <td>${formatDateTime(customer.createdAt)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="showSingleTransferModal('${customer.id}')" 
                                title="转移客户">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // 更新分页
            renderPagination();
        }

        // 渲染分页
        function renderPagination() {
            const totalPages = Math.ceil(filteredCustomers.length / customersPerPage);
            const pagination = document.getElementById('customersPagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'block';
            const ul = pagination.querySelector('ul');
            
            let paginationHTML = '';
            
            // 上一页
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>
                </li>
            `;
            
            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            // 下一页
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>
                </li>
            `;
            
            ul.innerHTML = paginationHTML;
        }

        // 切换页面
        function changePage(page) {
            const totalPages = Math.ceil(filteredCustomers.length / customersPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderCustomersList();
        }

        // 搜索客户
        function searchCustomers() {
            const searchTerm = document.getElementById('searchCustomers').value.toLowerCase();
            const statusFilter = document.getElementById('filterCustomerStatus').value;

            filteredCustomers = allCustomers.filter(customer => {
                // 搜索过滤
                const matchesSearch = !searchTerm || 
                    (customer.username || '').toLowerCase().includes(searchTerm) ||
                    (customer.nickname || '').toLowerCase().includes(searchTerm) ||
                    (customer.email || '').toLowerCase().includes(searchTerm);

                // 状态过滤
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'active' && customer.isActive) ||
                    (statusFilter === 'inactive' && !customer.isActive);

                return matchesSearch && matchesStatus;
            });

            currentPage = 1;
            selectedCustomers = [];
            updateCustomerCount();
            updateBatchTransferButton();
            renderCustomersList();
        }

        // 更新客户数量显示
        function updateCustomerCount() {
            document.getElementById('customerCount').textContent = filteredCustomers.length;
        }

        // 切换客户选择
        function toggleCustomerSelection(customerId) {
            const checkbox = document.querySelector(`input[value="${customerId}"]`);
            if (checkbox.checked) {
                if (!selectedCustomers.includes(customerId)) {
                    selectedCustomers.push(customerId);
                }
            } else {
                selectedCustomers = selectedCustomers.filter(id => id !== customerId);
            }
            
            updateSelectAllCheckbox();
            updateBatchTransferButton();
        }

        // 切换全选
        function toggleSelectAllCustomers() {
            const selectAllCheckbox = document.getElementById('selectAllCustomers');
            const customerCheckboxes = document.querySelectorAll('.customer-checkbox');
            
            if (selectAllCheckbox.checked) {
                customerCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    const customerId = checkbox.value;
                    if (!selectedCustomers.includes(customerId)) {
                        selectedCustomers.push(customerId);
                    }
                });
            } else {
                customerCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectedCustomers = [];
            }
            
            updateBatchTransferButton();
        }

        // 更新全选复选框状态
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllCustomers');
            const customerCheckboxes = document.querySelectorAll('.customer-checkbox');
            const checkedCount = document.querySelectorAll('.customer-checkbox:checked').length;
            
            if (checkedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedCount === customerCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
        }

        // 更新批量转移按钮状态
        function updateBatchTransferButton() {
            const batchTransferBtn = document.getElementById('batchTransferBtn');
            batchTransferBtn.disabled = selectedCustomers.length === 0;
            batchTransferBtn.innerHTML = selectedCustomers.length > 0 
                ? `<i class="fas fa-exchange-alt"></i> 批量转移 (${selectedCustomers.length})`
                : `<i class="fas fa-exchange-alt"></i> 批量转移`;
        }

        // 加载业务员选项
        async function loadSalespersonOptions() {
            try {
                const selects = [
                    document.getElementById('targetSalespersonSelect'),
                    document.getElementById('batchTargetSalespersonSelect')
                ];

                const options = staffData
                    .filter(staff => staff.id !== currentStaffId && staff.isActive)
                    .map(staff => `<option value="${staff.id}">${staff.nickname} (${staff.username})</option>`)
                    .join('');

                selects.forEach(select => {
                    select.innerHTML = '<option value="">请选择目标业务员</option>' + options;
                });

            } catch (error) {
                console.error('加载业务员选项失败:', error);
            }
        }

        // 显示单个客户转移模态框
        function showSingleTransferModal(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;

            document.getElementById('transferCustomerInfo').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>用户名:</strong> ${customer.username || '-'}
                    </div>
                    <div class="col-md-6">
                        <strong>昵称:</strong> ${customer.nickname || '-'}
                    </div>
                    <div class="col-md-6">
                        <strong>邮箱:</strong> ${customer.email || '-'}
                    </div>
                    <div class="col-md-6">
                        <strong>当前邀请码:</strong> <code class="text-primary">${customer.inviteCode || '-'}</code>
                    </div>
                </div>
            `;

            // 存储当前转移的客户ID
            document.getElementById('transferSingleCustomerModal').setAttribute('data-customer-id', customerId);

            const modal = new bootstrap.Modal(document.getElementById('transferSingleCustomerModal'));
            modal.show();
        }

        // 确认单个客户转移
        async function confirmSingleTransfer() {
            const customerId = document.getElementById('transferSingleCustomerModal').getAttribute('data-customer-id');
            const targetSalespersonId = document.getElementById('targetSalespersonSelect').value;

            if (!targetSalespersonId) {
                Swal.fire({
                    title: '请选择目标业务员',
                    icon: 'warning'
                });
                return;
            }

            try {
                Swal.fire({
                    title: '正在转移客户',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetch(`${API_BASE_URL}/api/salesperson/transfer-customers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sourceSalespersonId: currentStaffId,
                        targetSalespersonId: targetSalespersonId,
                        customerIds: [customerId]
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || '转移失败');
                }

                // 关闭转移模态框
                bootstrap.Modal.getInstance(document.getElementById('transferSingleCustomerModal')).hide();

                // 刷新客户列表
                await showStaffCustomers(currentStaffId);

                // 刷新业务员列表
                await loadStaffList();

                Swal.fire({
                    title: '转移成功',
                    text: `客户已成功转移到 ${result.targetSalesperson.nickname}`,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('客户转移失败:', error);
                Swal.fire({
                    title: '转移失败',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // 显示批量转移模态框
        function showBatchTransferModal() {
            if (selectedCustomers.length === 0) {
                Swal.fire({
                    title: '请选择要转移的客户',
                    icon: 'warning'
                });
                return;
            }

            const selectedCustomerData = allCustomers.filter(c => selectedCustomers.includes(c.id));
            
            document.getElementById('selectedCustomersInfo').innerHTML = `
                <div class="mb-2">
                    <strong>选中 ${selectedCustomers.length} 个客户:</strong>
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${selectedCustomerData.map(customer => `
                        <div class="border-bottom py-1">
                            <span class="fw-bold">${customer.username}</span> 
                            (${customer.nickname || '-'}) - 
                            <code class="text-primary">${customer.inviteCode || '-'}</code>
                        </div>
                    `).join('')}
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('batchTransferModal'));
            modal.show();
        }

        // 确认批量转移
        async function confirmBatchTransfer() {
            const targetSalespersonId = document.getElementById('batchTargetSalespersonSelect').value;

            if (!targetSalespersonId) {
                Swal.fire({
                    title: '请选择目标业务员',
                    icon: 'warning'
                });
                return;
            }

            try {
                Swal.fire({
                    title: '正在批量转移客户',
                    text: `正在转移 ${selectedCustomers.length} 个客户...`,
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetch(`${API_BASE_URL}/api/salesperson/transfer-customers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sourceSalespersonId: currentStaffId,
                        targetSalespersonId: targetSalespersonId,
                        customerIds: selectedCustomers
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || '批量转移失败');
                }

                // 关闭批量转移模态框
                bootstrap.Modal.getInstance(document.getElementById('batchTransferModal')).hide();

                // 刷新客户列表
                await showStaffCustomers(currentStaffId);

                // 刷新业务员列表
                await loadStaffList();

                Swal.fire({
                    title: '批量转移成功',
                    html: `
                        <div class="text-center">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <p>已成功转移 <strong>${result.transferredCount}</strong> 个客户到业务员 <strong>${result.targetSalesperson.nickname}</strong></p>
                        </div>
                    `,
                    icon: 'success',
                    timer: 3000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('批量转移失败:', error);
                Swal.fire({
                    title: '批量转移失败',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // LOGO上传处理
        function handleLogoUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('logoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" class="img-fluid" style="max-height: 80px;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // ==================== 轮播图管理功能 ====================
        
        // 轮播图数据
        let slideshowData = [];
        


        // 加载轮播图列表
        async function loadSlideshowList() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/slideshow`);
                
                if (response.ok) {
                    slideshowData = await response.json();
                    displaySlideshowList();
                } else {
                    const errorText = await response.text();
                    console.error('获取轮播图列表失败:', response.status, response.statusText, errorText);
                    Swal.fire({
                        title: '错误',
                        text: `获取轮播图列表失败: ${response.status} ${response.statusText}`,
                        icon: 'error'
                    });
                }
            } catch (error) {
                console.error('获取轮播图列表失败:', error);
                Swal.fire({
                    title: '错误',
                    text: '获取轮播图列表失败',
                    icon: 'error'
                });
            }
        }

        // 显示轮播图列表
        function displaySlideshowList() {
            const tbody = document.getElementById('slideshowList');
            
            if (slideshowData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-images fa-2x mb-2"></i><br>
                            暂无轮播图数据
                        </td>
                    </tr>
                `;
                return;
            }

            // 按order排序
            const sortedData = [...slideshowData].sort((a, b) => a.order - b.order);
            
            tbody.innerHTML = sortedData.map(item => `
                <tr data-id="${item.id}">
                    <td>
                        <span class="order-number">${item.order}</span>
                        <div class="order-controls ms-2" style="display: inline-block;">
                            <button class="btn btn-sm btn-outline-secondary" onclick="moveSlideshow('${item.id}', 'up')" title="上移">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="moveSlideshow('${item.id}', 'down')" title="下移">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <img src="${item.image || 'https://via.placeholder.com/100x60'}" 
                             class="img-thumbnail slideshow-preview" 
                             style="width: 100px; height: 60px; object-fit: cover; cursor: pointer;"
                             onclick="previewSlideshow('${item.id}')"
                             onerror="this.src='https://via.placeholder.com/100x60'">
                    </td>
                    <td>
                        <div class="slideshow-title">${item.title || '<span class="text-muted">未设置标题</span>'}</div>
                    </td>
                    <td>
                        <div class="slideshow-description">${item.description || '<span class="text-muted">未设置描述</span>'}</div>
                    </td>
                    <td>
                        <span class="status-badge status-active">启用</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editSlideshow('${item.id}')">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSlideshow('${item.id}')">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 添加轮播图
        function addSlideshow() {
            Swal.fire({
                title: '添加轮播图',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">轮播图图片 <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="slideshowImageInput" accept="image/*">
                            <div class="form-text">支持JPG、PNG格式，建议尺寸1920x600，文件大小不超过5MB</div>
                            <div id="imagePreviewContainer" class="mt-2" style="display: none;">
                                <img id="imagePreview" class="img-thumbnail" style="max-width: 200px; max-height: 100px;">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">标题</label>
                            <input type="text" class="form-control" id="slideshowTitle" placeholder="请输入轮播图标题">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" id="slideshowDescription" rows="3" placeholder="请输入轮播图描述"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">链接地址</label>
                            <input type="url" class="form-control" id="slideshowLink" placeholder="请输入跳转链接（可选）">
                        </div>
                    </div>
                `,
                width: '600px',
                showCancelButton: true,
                confirmButtonText: '添加',
                cancelButtonText: '取消',
                confirmButtonColor: '#28a745',
                preConfirm: () => {
                    const imageInput = document.getElementById('slideshowImageInput');
                    const title = document.getElementById('slideshowTitle').value.trim();
                    const description = document.getElementById('slideshowDescription').value.trim();
                    const link = document.getElementById('slideshowLink').value.trim();

                    if (!imageInput.files[0]) {
                        Swal.showValidationMessage('请选择轮播图图片');
                        return false;
                    }

                    return {
                        image: imageInput.files[0],
                        title,
                        description,
                        link
                    };
                },
                didOpen: () => {
                    // 图片预览功能
                    document.getElementById('slideshowImageInput').addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            // 验证文件类型
                            if (!file.type.startsWith('image/')) {
                                Swal.showValidationMessage('请选择有效的图片文件');
                                return;
                            }

                            // 验证文件大小
                            if (file.size > 5 * 1024 * 1024) {
                                Swal.showValidationMessage('图片文件大小不能超过5MB');
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const preview = document.getElementById('imagePreview');
                                const container = document.getElementById('imagePreviewContainer');
                                preview.src = e.target.result;
                                container.style.display = 'block';
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await uploadSlideshow(result.value);
                }
            });
        }

        // 上传轮播图
        async function uploadSlideshow(data) {
            try {
                console.log('开始上传轮播图:', data);
                
                // 显示加载状态
                Swal.fire({
                    title: '上传中...',
                    text: '正在上传轮播图，请稍候',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 上传图片
                const formData = new FormData();
                formData.append('image', data.image);
                console.log('准备上传图片文件:', data.image.name, '大小:', data.image.size);

                const uploadResponse = await fetch(`${API_BASE_URL}/api/admin/slideshow/upload`, {
                    method: 'POST',
                    body: formData
                });

                console.log('图片上传响应状态:', uploadResponse.status, uploadResponse.statusText);

                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    console.error('图片上传失败:', uploadResponse.status, uploadResponse.statusText, errorText);
                    let errorMessage = '上传失败';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const uploadResult = await uploadResponse.json();

                // 更新轮播图信息
                if (data.title || data.description || data.link) {
                    const updateData = {
                        title: data.title,
                        description: data.description,
                        link: data.link
                    };

                    const updateResponse = await fetch(`${API_BASE_URL}/api/admin/slideshow/${uploadResult.data.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (!updateResponse.ok) {
                        const errorData = await updateResponse.json();
                        throw new Error(errorData.message || '更新信息失败');
                    }
                }

                // 重新加载列表
                await loadSlideshowList();

                Swal.fire({
                    title: '成功',
                    text: '轮播图添加成功',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('上传轮播图失败:', error);
                Swal.fire({
                    title: '错误',
                    text: error.message || '上传轮播图失败',
                    icon: 'error'
                });
            }
        }

        // 编辑轮播图
        function editSlideshow(id) {
            const slideshow = slideshowData.find(item => item.id === id);
            if (!slideshow) {
                Swal.fire({
                    title: '错误',
                    text: '轮播图不存在',
                    icon: 'error'
                });
                return;
            }

            Swal.fire({
                title: '编辑轮播图',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">当前图片</label>
                            <div class="mb-2">
                                <img src="${slideshow.image}" class="img-thumbnail" style="max-width: 200px; max-height: 100px;">
                            </div>
                            <label class="form-label">更换图片（可选）</label>
                            <input type="file" class="form-control" id="editSlideshowImageInput" accept="image/*">
                            <div class="form-text">支持JPG、PNG格式，建议尺寸1920x600，文件大小不超过5MB</div>
                            <div id="editImagePreviewContainer" class="mt-2" style="display: none;">
                                <img id="editImagePreview" class="img-thumbnail" style="max-width: 200px; max-height: 100px;">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">标题</label>
                            <input type="text" class="form-control" id="editSlideshowTitle" value="${slideshow.title || ''}" placeholder="请输入轮播图标题">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" id="editSlideshowDescription" rows="3" placeholder="请输入轮播图描述">${slideshow.description || ''}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">链接地址</label>
                            <input type="url" class="form-control" id="editSlideshowLink" value="${slideshow.link || ''}" placeholder="请输入跳转链接（可选）">
                        </div>
                    </div>
                `,
                width: '600px',
                showCancelButton: true,
                confirmButtonText: '保存',
                cancelButtonText: '取消',
                confirmButtonColor: '#007bff',
                preConfirm: () => {
                    const imageInput = document.getElementById('editSlideshowImageInput');
                    const title = document.getElementById('editSlideshowTitle').value.trim();
                    const description = document.getElementById('editSlideshowDescription').value.trim();
                    const link = document.getElementById('editSlideshowLink').value.trim();

                    return {
                        image: imageInput.files[0] || null,
                        title,
                        description,
                        link
                    };
                },
                didOpen: () => {
                    // 图片预览功能
                    document.getElementById('editSlideshowImageInput').addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            // 验证文件类型
                            if (!file.type.startsWith('image/')) {
                                Swal.showValidationMessage('请选择有效的图片文件');
                                return;
                            }

                            // 验证文件大小
                            if (file.size > 5 * 1024 * 1024) {
                                Swal.showValidationMessage('图片文件大小不能超过5MB');
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const preview = document.getElementById('editImagePreview');
                                const container = document.getElementById('editImagePreviewContainer');
                                preview.src = e.target.result;
                                container.style.display = 'block';
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await updateSlideshow(id, result.value);
                }
            });
        }

        // 更新轮播图
        async function updateSlideshow(id, data) {
            try {
                // 显示加载状态
                Swal.fire({
                    title: '更新中...',
                    text: '正在更新轮播图，请稍候',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 如果有新图片，先上传图片
                if (data.image) {
                    const formData = new FormData();
                    formData.append('image', data.image);

                    const uploadResponse = await fetch(`${API_BASE_URL}/api/admin/slideshow/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        const errorData = await uploadResponse.json();
                        throw new Error(errorData.message || '图片上传失败');
                    }

                    const uploadResult = await uploadResponse.json();
                    
                    // 删除旧的轮播图
                    await fetch(`${API_BASE_URL}/api/admin/slideshow/${id}`, {
                        method: 'DELETE'
                    });

                    // 更新新轮播图的信息
                    const updateData = {
                        title: data.title,
                        description: data.description,
                        link: data.link
                    };

                    const updateResponse = await fetch(`${API_BASE_URL}/api/admin/slideshow/${uploadResult.data.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (!updateResponse.ok) {
                        const errorData = await updateResponse.json();
                        throw new Error(errorData.message || '更新信息失败');
                    }
                } else {
                    // 只更新文字信息
                    const updateData = {
                        title: data.title,
                        description: data.description,
                        link: data.link
                    };

                    const updateResponse = await fetch(`${API_BASE_URL}/api/admin/slideshow/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (!updateResponse.ok) {
                        const errorData = await updateResponse.json();
                        throw new Error(errorData.message || '更新失败');
                    }
                }

                // 重新加载列表
                await loadSlideshowList();

                Swal.fire({
                    title: '成功',
                    text: '轮播图更新成功',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('更新轮播图失败:', error);
                Swal.fire({
                    title: '错误',
                    text: error.message || '更新轮播图失败',
                    icon: 'error'
                });
            }
        }

        // 删除轮播图
        function deleteSlideshow(id) {
            const slideshow = slideshowData.find(item => item.id === id);
            if (!slideshow) {
                Swal.fire({
                    title: '错误',
                    text: '轮播图不存在',
                    icon: 'error'
                });
                return;
            }

            Swal.fire({
                title: '确认删除',
                html: `
                    <div class="text-center">
                        <img src="${slideshow.image}" class="img-thumbnail mb-3" style="max-width: 200px; max-height: 100px;">
                        <p>确定要删除这个轮播图吗？</p>
                        <p class="text-muted">删除后无法恢复</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '确定删除',
                cancelButtonText: '取消',
                confirmButtonColor: '#dc3545'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        // 显示加载状态
                        Swal.fire({
                            title: '删除中...',
                            text: '正在删除轮播图，请稍候',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const response = await fetch(`${API_BASE_URL}/api/admin/slideshow/${id}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || '删除失败');
                        }

                        // 重新加载列表
                        await loadSlideshowList();

                        Swal.fire({
                            title: '成功',
                            text: '轮播图删除成功',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });

                    } catch (error) {
                        console.error('删除轮播图失败:', error);
                        Swal.fire({
                            title: '错误',
                            text: error.message || '删除轮播图失败',
                            icon: 'error'
                        });
                    }
                }
            });
        }

        // 移动轮播图顺序
        async function moveSlideshow(id, direction) {
            const currentIndex = slideshowData.findIndex(item => item.id === id);
            if (currentIndex === -1) return;

            const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (newIndex < 0 || newIndex >= slideshowData.length) return;

            try {
                // 交换order值
                const currentItem = slideshowData[currentIndex];
                const targetItem = slideshowData[newIndex];
                
                const tempOrder = currentItem.order;
                currentItem.order = targetItem.order;
                targetItem.order = tempOrder;

                // 更新两个项目的order
                await Promise.all([
                    fetch(`${API_BASE_URL}/api/admin/slideshow/${currentItem.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            title: currentItem.title,
                            description: currentItem.description,
                            link: currentItem.link
                        })
                    }),
                    fetch(`${API_BASE_URL}/api/admin/slideshow/${targetItem.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            title: targetItem.title,
                            description: targetItem.description,
                            link: targetItem.link
                        })
                    })
                ]);

                // 重新加载列表
                await loadSlideshowList();

            } catch (error) {
                console.error('移动轮播图失败:', error);
                Swal.fire({
                    title: '错误',
                    text: '移动轮播图失败',
                    icon: 'error'
                });
            }
        }

        // 预览轮播图
        function previewSlideshow(id) {
            const slideshow = slideshowData.find(item => item.id === id);
            if (!slideshow) return;

            Swal.fire({
                title: slideshow.title || '轮播图预览',
                html: `
                    <div class="text-center">
                        <img src="${slideshow.image}" class="img-fluid mb-3" style="max-width: 100%; max-height: 400px;">
                        ${slideshow.description ? `<p class="text-muted">${slideshow.description}</p>` : ''}
                        ${slideshow.link ? `<p><a href="${slideshow.link}" target="_blank" class="btn btn-primary btn-sm">访问链接</a></p>` : ''}
                    </div>
                `,
                width: '600px',
                showConfirmButton: false,
                showCloseButton: true
            });
        }



        // ==================== 区号管理功能 ====================
        
        let countryCodesData = [];
        let sortableInstance = null;

        // 页面加载时初始化区号管理
        function initCountryCodeManagement() {
            console.log('初始化区号管理功能...');
            loadCountryCodes();
            initSortable();
        }

        // 加载区号列表
        async function loadCountryCodes() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/countrycode`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                countryCodesData = await response.json();
                renderCountryCodesList();
                
                // 重新初始化拖拽排序
                if (sortableInstance) {
                    sortableInstance.destroy();
                }
                initSortable();
                
            } catch (error) {
                console.error('加载区号列表失败:', error);
                Swal.fire({
                    title: '加载失败',
                    text: '无法加载区号列表，请检查网络连接',
                    icon: 'error'
                });
            }
        }

        // 渲染区号列表
        function renderCountryCodesList() {
            const tbody = document.getElementById('countryCodesList');
            if (!tbody) return;

            if (countryCodesData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            暂无区号数据
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = countryCodesData.map(code => `
                <tr data-id="${code.id}" class="sortable-row">
                    <td class="text-center">
                        <i class="fas fa-grip-vertical text-muted sortable-handle" style="cursor: move;"></i>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-secondary">${code.sortOrder}</span>
                    </td>
                    <td class="text-center" style="font-size: 1.2em;">
                        ${code.flag || '🌍'}
                    </td>
                    <td>${code.countryName}</td>
                    <td>
                        <span class="badge bg-info">${code.id}</span>
                    </td>
                    <td>
                        <span class="badge bg-primary">${code.code}</span>
                    </td>
                    <td class="text-center">
                        <div class="status-dot ${code.enabled ? 'enabled' : 'disabled'}" 
                             onclick="toggleCountryCodeStatus('${code.id}')" 
                             title="${code.enabled ? '点击禁用' : '点击启用'}">
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="default-dot ${code.isDefault ? 'is-default' : 'not-default'}" 
                             onclick="${code.isDefault ? '' : `setDefaultCountryCode(${code.id})`}" 
                             title="${code.isDefault ? '当前默认区号' : '点击设为默认'}">
                        </div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editCountryCode('${code.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteCountryCode('${code.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 初始化拖拽排序
        function initSortable() {
            const tbody = document.getElementById('countryCodesList');
            if (!tbody) return;

            sortableInstance = new Sortable(tbody, {
                handle: '.sortable-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    updateSortOrder();
                }
            });
        }

        // 更新排序
        async function updateSortOrder() {
            try {
                const rows = document.querySelectorAll('#countryCodesList tr[data-id]');
                const updates = Array.from(rows).map((row, index) => ({
                    Id: row.dataset.id,  // 注意大写的Id
                    SortOrder: index + 1  // 注意大写的SortOrder
                }));

                // 构造符合后端期望的数据格式
                const requestData = {
                    Updates: updates
                };

                console.log('发送排序更新请求:', requestData);

                const response = await fetch(`${API_BASE_URL}/api/countrycode/batch-update-sort`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API响应错误:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                console.log('排序更新响应:', result);

                // 更新本地数据
                updates.forEach(item => {
                    const code = countryCodesData.find(c => c.id === item.Id);
                    if (code) {
                        code.sortOrder = item.SortOrder;
                    }
                });

                renderCountryCodesList();
                
                Swal.fire({
                    title: '排序更新成功',
                    text: result.message || '排序已更新',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('更新排序失败:', error);
                Swal.fire({
                    title: '排序更新失败',
                    text: `错误详情: ${error.message}`,
                    icon: 'error'
                });
                // 重新加载数据恢复原状态
                loadCountryCodes();
            }
        }

        // 添加区号
        async function addCountryCode() {
            const { value: formValues } = await Swal.fire({
                title: '添加区号',
                html: `
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">国家/地区名称</label>
                            <input id="countryName" class="form-control" placeholder="如：中国" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">国家代码</label>
                            <input id="countryCode" class="form-control" placeholder="如：CN" maxlength="2" style="text-transform: uppercase;" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">电话区号</label>
                            <input id="phoneCode" class="form-control" placeholder="如：+86" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">国旗 Emoji</label>
                            <input id="flag" class="form-control" placeholder="如：🇨🇳" maxlength="4">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">排序顺序</label>
                            <input id="sortOrder" type="number" class="form-control" value="${countryCodesData.length + 1}" min="1">
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="isEnabled" checked>
                                <label class="form-check-label" for="isEnabled">启用状态</label>
                            </div>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: '添加',
                cancelButtonText: '取消',
                width: '600px',
                preConfirm: () => {
                    const countryName = document.getElementById('countryName').value.trim();
                    const countryCode = document.getElementById('countryCode').value.trim().toUpperCase();
                    const phoneCode = document.getElementById('phoneCode').value.trim();
                    const flag = document.getElementById('flag').value.trim();
                    const sortOrder = parseInt(document.getElementById('sortOrder').value);
                    const isEnabled = document.getElementById('isEnabled').checked;

                    if (!countryName || !countryCode || !phoneCode) {
                        Swal.showValidationMessage('请填写所有必填字段');
                        return false;
                    }

                    if (countryCode.length !== 2) {
                        Swal.showValidationMessage('国家代码必须是2位字母');
                        return false;
                    }

                    if (!phoneCode.startsWith('+')) {
                        Swal.showValidationMessage('电话区号必须以+开头');
                        return false;
                    }

                    return {
                        countryName,
                        code: phoneCode,
                        flag,
                        sortOrder,
                        enabled: isEnabled
                    };
                }
            });

            if (formValues) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/countrycode`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formValues)
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || `HTTP error! status: ${response.status}`);
                    }

                    await loadCountryCodes();
                    
                    Swal.fire({
                        title: '添加成功',
                        text: '区号已成功添加',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });

                } catch (error) {
                    console.error('添加区号失败:', error);
                    Swal.fire({
                        title: '添加失败',
                        text: error.message || '请重试或检查网络连接',
                        icon: 'error'
                    });
                }
            }
        }

        // 编辑区号
        async function editCountryCode(id) {
            const code = countryCodesData.find(c => c.id === id);
            if (!code) return;

            const { value: formValues } = await Swal.fire({
                title: '编辑区号',
                html: `
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">国家/地区名称</label>
                            <input id="countryName" class="form-control" value="${code.countryName}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">国家代码</label>
                            <input id="countryCode" class="form-control" value="${code.id}" maxlength="2" style="text-transform: uppercase;" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">电话区号</label>
                            <input id="phoneCode" class="form-control" value="${code.code}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">国旗 Emoji</label>
                            <input id="flag" class="form-control" value="${code.flag || ''}" maxlength="4">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">排序顺序</label>
                            <input id="sortOrder" type="number" class="form-control" value="${code.sortOrder}" min="1">
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="isEnabled" ${code.enabled ? 'checked' : ''}>
                                <label class="form-check-label" for="isEnabled">启用状态</label>
                            </div>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: '保存',
                cancelButtonText: '取消',
                width: '600px',
                preConfirm: () => {
                    const countryName = document.getElementById('countryName').value.trim();
                    const countryCode = document.getElementById('countryCode').value.trim().toUpperCase();
                    const phoneCode = document.getElementById('phoneCode').value.trim();
                    const flag = document.getElementById('flag').value.trim();
                    const sortOrder = parseInt(document.getElementById('sortOrder').value);
                    const isEnabled = document.getElementById('isEnabled').checked;

                    if (!countryName || !countryCode || !phoneCode) {
                        Swal.showValidationMessage('请填写所有必填字段');
                        return false;
                    }

                    if (countryCode.length !== 2) {
                        Swal.showValidationMessage('国家代码必须是2位字母');
                        return false;
                    }

                    if (!phoneCode.startsWith('+')) {
                        Swal.showValidationMessage('电话区号必须以+开头');
                        return false;
                    }

                    return {
                        countryName,
                        code: phoneCode,
                        flag,
                        sortOrder,
                        enabled: isEnabled
                    };
                }
            });

            if (formValues) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/countrycode/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formValues)
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || `HTTP error! status: ${response.status}`);
                    }

                    await loadCountryCodes();
                    
                    Swal.fire({
                        title: '更新成功',
                        text: '区号信息已更新',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });

                } catch (error) {
                    console.error('更新区号失败:', error);
                    Swal.fire({
                        title: '更新失败',
                        text: error.message || '请重试或检查网络连接',
                        icon: 'error'
                    });
                }
            }
        }

        // 删除区号
        async function deleteCountryCode(id) {
            const code = countryCodesData.find(c => c.id === id);
            if (!code) return;

            const result = await Swal.fire({
                title: '确认删除',
                text: `确定要删除区号 "${code.countryName} (${code.code})" 吗？`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '删除',
                cancelButtonText: '取消'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/countrycode/${id}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || `HTTP error! status: ${response.status}`);
                    }

                    await loadCountryCodes();
                    
                    Swal.fire({
                        title: '删除成功',
                        text: '区号已被删除',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });

                } catch (error) {
                    console.error('删除区号失败:', error);
                    Swal.fire({
                        title: '删除失败',
                        text: error.message || '请重试或检查网络连接',
                        icon: 'error'
                    });
                }
            }
        }

        // 设置默认区号
        async function setDefaultCountryCode(id) {
            const code = countryCodesData.find(c => c.id === id);
            if (!code) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/countrycode/${id}/set-default`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || `HTTP error! status: ${response.status}`);
                }

                await loadCountryCodes();
                
                Swal.fire({
                    title: '设置成功',
                    text: `"${code.countryName} (${code.code})" 已设为默认区号`,
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('设置默认区号失败:', error);
                Swal.fire({
                    title: '设置失败',
                    text: error.message || '请重试或检查网络连接',
                    icon: 'error'
                });
            }
        }

        // 切换区号状态
        async function toggleCountryCodeStatus(id) {
            const code = countryCodesData.find(c => c.id === id);
            if (!code) return;

            try {
                const newStatus = !code.enabled;
                const response = await fetch(`${API_BASE_URL}/api/countrycode/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...code,
                        enabled: newStatus
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || `HTTP error! status: ${response.status}`);
                }

                await loadCountryCodes();
                
                Swal.fire({
                    title: '状态更新成功',
                    text: `区号已${newStatus ? '启用' : '禁用'}`,
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('更新状态失败:', error);
                Swal.fire({
                    title: '状态更新失败',
                    text: error.message || '请重试或检查网络连接',
                    icon: 'error'
                });
            }
        }

        // ==================== VIP等级管理功能 ====================
        
        // VIP等级数据
        let vipLevelsData = [];
        
        // 加载VIP等级列表
        async function loadVipLevels() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/config/vip-levels`);
                if (response.ok) {
                    vipLevelsData = await response.json();
                    renderVipLevelsList();
                } else {
                    throw new Error(`获取VIP等级列表失败: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('加载VIP等级失败:', error);
                Swal.fire({
                    title: '错误',
                    text: '加载VIP等级列表失败',
                    icon: 'error'
                });
            }
        }
        
        // 渲染VIP等级列表
        function renderVipLevelsList() {
            const tbody = document.getElementById('vipLevelsList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            vipLevelsData.forEach((level, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="badge fs-6 px-3 py-2" style="background-color: ${level.color || '#6B7280'}; color: white;">
                            ${level.icon || '👑'} ${level.level}
                        </span>
                    </td>
                    <td>
                        <strong>${level.name || `VIP - ${level.level}`}</strong>
                    </td>
                    <td>
                        <span class="text-success fw-bold">¥${(level.min_deposit || 0).toLocaleString()}</span>
                    </td>
                    <td>
                        <span class="badge bg-warning text-dark">${((level.commission_rate || 0) * 100).toFixed(1)}%</span>
                    </td>
                    <td>
                        <span class="text-primary fw-bold">${level.daily_order_limit || 0}</span>
                    </td>
                    <td>
                        <span class="text-success">¥${(level.withdrawal_limit || 0).toLocaleString()}</span>
                    </td>
                    <td>
                        <span class="badge bg-info">${(level.benefits || []).length} 项</span>
                    </td>
                    <td>
                        <span class="badge bg-success">启用</span>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-primary btn-sm" onclick="editVipLevel(${level.level})" title="编辑VIP等级信息">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="viewVipBenefits(${level.level})" title="查看VIP权益详情">
                                <i class="fas fa-list"></i> 权益
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        

        
        // 编辑VIP等级
        async function editVipLevel(level) {
            const vipLevel = vipLevelsData.find(v => v.level === level);
            if (!vipLevel) {
                Swal.fire('错误', '未找到指定的VIP等级', 'error');
                return;
            }
            
            Swal.fire({
                title: `编辑VIP等级 ${level}`,
                html: `
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">等级</label>
                            <input type="number" id="edit-vip-level" class="form-control" value="${vipLevel.level}" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">名称</label>
                            <input type="text" id="edit-vip-name" class="form-control" value="${vipLevel.name || ''}" placeholder="VIP等级名称">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">最低充值 (¥)</label>
                            <input type="number" id="edit-vip-min-deposit" class="form-control" value="${vipLevel.min_deposit || 0}" min="0" step="100">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">佣金率 (%)</label>
                            <input type="number" id="edit-vip-commission-rate" class="form-control" value="${((vipLevel.commission_rate || 0) * 100).toFixed(1)}" min="0" max="100" step="0.1">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">每日订单限制</label>
                            <input type="number" id="edit-vip-daily-limit" class="form-control" value="${vipLevel.daily_order_limit || 0}" min="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">提现限额 (¥)</label>
                            <input type="number" id="edit-vip-withdrawal-limit" class="form-control" value="${vipLevel.withdrawal_limit || 0}" min="0" step="1000">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">颜色</label>
                            <input type="color" id="edit-vip-color" class="form-control" value="${vipLevel.color || '#3498db'}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">图标</label>
                            <select id="edit-vip-icon" class="form-control">
                                <option value="👑" ${vipLevel.icon === '👑' ? 'selected' : ''}>👑 皇冠</option>
                                <option value="💎" ${vipLevel.icon === '💎' ? 'selected' : ''}>💎 钻石</option>
                                <option value="🥇" ${vipLevel.icon === '🥇' ? 'selected' : ''}>🥇 金牌</option>
                                <option value="🥈" ${vipLevel.icon === '🥈' ? 'selected' : ''}>🥈 银牌</option>
                                <option value="🥉" ${vipLevel.icon === '🥉' ? 'selected' : ''}>🥉 铜牌</option>
                                <option value="⭐" ${vipLevel.icon === '⭐' ? 'selected' : ''}>⭐ 星星</option>
                                <option value="🔥" ${vipLevel.icon === '🔥' ? 'selected' : ''}>🔥 火焰</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">权益列表</label>
                        <div id="edit-benefits-container">
                            ${(vipLevel.benefits || []).map(benefit => `
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control benefit-input" value="${benefit}" placeholder="输入权益描述">
                                    <button type="button" class="btn btn-outline-danger" onclick="removeBenefit(this)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="addBenefit('edit-benefits-container')">
                            <i class="fas fa-plus"></i> 添加权益
                        </button>
                    </div>
                `,
                width: '800px',
                showCancelButton: true,
                confirmButtonText: '保存',
                cancelButtonText: '取消',
                preConfirm: () => {
                    const name = document.getElementById('edit-vip-name').value.trim();
                    const minDeposit = parseFloat(document.getElementById('edit-vip-min-deposit').value) || 0;
                    const commissionRate = parseFloat(document.getElementById('edit-vip-commission-rate').value) / 100 || 0;
                    const dailyLimit = parseInt(document.getElementById('edit-vip-daily-limit').value) || 0;
                    const withdrawalLimit = parseFloat(document.getElementById('edit-vip-withdrawal-limit').value) || 0;
                    const color = document.getElementById('edit-vip-color').value;
                    const icon = document.getElementById('edit-vip-icon').value;
                    
                    const benefits = Array.from(document.querySelectorAll('#edit-benefits-container .benefit-input'))
                        .map(input => input.value.trim())
                        .filter(benefit => benefit.length > 0);
                    
                    if (!name) {
                        Swal.showValidationMessage('请输入VIP等级名称');
                        return false;
                    }
                    
                    if (benefits.length === 0) {
                        Swal.showValidationMessage('请至少添加一项权益');
                        return false;
                    }
                    
                    return {
                        level,
                        name,
                        min_deposit: minDeposit,
                        commission_rate: commissionRate,
                        daily_order_limit: dailyLimit,
                        withdrawal_limit: withdrawalLimit,
                        benefits,
                        color,
                        icon
                    };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await updateVipLevel(level, result.value);
                }
            });
        }
        
        // 查看VIP权益
        function viewVipBenefits(level) {
            const vipLevel = vipLevelsData.find(v => v.level === level);
            if (!vipLevel) {
                Swal.fire('错误', '未找到指定的VIP等级', 'error');
                return;
            }
            
            const benefitsHtml = (vipLevel.benefits || []).map((benefit, index) => 
                `<div class="alert alert-info mb-2">
                    <strong>${index + 1}.</strong> ${benefit}
                </div>`
            ).join('');
            
            Swal.fire({
                title: `${vipLevel.name} 权益详情`,
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <span class="badge" style="background-color: ${vipLevel.color}; color: white; font-size: 1.2em;">
                                ${vipLevel.icon} ${vipLevel.name}
                            </span>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>最低充值:</strong> ¥${(vipLevel.min_deposit || 0).toLocaleString()}</div>
                            <div class="col-6"><strong>佣金率:</strong> ${((vipLevel.commission_rate || 0) * 100).toFixed(1)}%</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>每日订单:</strong> ${vipLevel.daily_order_limit || 0}</div>
                            <div class="col-6"><strong>提现限额:</strong> ¥${(vipLevel.withdrawal_limit || 0).toLocaleString()}</div>
                        </div>
                        <h6>专享权益:</h6>
                        ${benefitsHtml || '<div class="text-muted">暂无权益信息</div>'}
                    </div>
                `,
                width: '600px',
                confirmButtonText: '关闭'
            });
        }
        

        

        
        // 更新VIP等级
        async function updateVipLevel(level, vipData) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/vip/levels/${level}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        MinDeposit: vipData.min_deposit,
                        CommissionRate: vipData.commission_rate,
                        DailyOrderLimit: vipData.daily_order_limit,
                        Benefits: vipData.benefits
                    })
                });
                
                if (response.ok) {
                    Swal.fire('成功', 'VIP等级更新成功', 'success');
                    await loadVipLevels(); // 重新加载列表
                } else {
                    throw new Error('更新失败');
                }
            } catch (error) {
                console.error('更新VIP等级失败:', error);
                Swal.fire('错误', '更新VIP等级失败', 'error');
            }
        }
        
        // 添加权益输入框
        function addBenefit(containerId = 'benefits-container') {
            const container = document.getElementById(containerId);
            const benefitDiv = document.createElement('div');
            benefitDiv.className = 'input-group mb-2';
            benefitDiv.innerHTML = `
                <input type="text" class="form-control benefit-input" placeholder="输入权益描述">
                <button type="button" class="btn btn-outline-danger" onclick="removeBenefit(this)">
                    <i class="fas fa-minus"></i>
                </button>
            `;
            container.appendChild(benefitDiv);
        }
        
        // 移除权益输入框
        function removeBenefit(button) {
            const container = button.closest('.input-group');
            if (container) {
                container.remove();
            }
        }

        // ==================== 会员管理功能 ====================
        
        // 会员管理相关变量
        let membersData = [];
        let filteredMembersData = [];
        let currentMemberPage = 1;
        let memberPageSize = 10;
        let memberSearchTerm = '';
        let memberStatusFilter = '';
        let memberVipFilter = '';
        let agentAccounts = new Set(); // 存储业务员账户信息
        
        // VIP等级映射
        const vipLevelNames = {
            1: 'VIP 1 🥉',
            2: 'VIP 2 🥈', 
            3: 'VIP 3 🥇',
            4: 'VIP 4 👑'
        };
        
        // 页面加载时初始化会员列表
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('membersList')) {
                loadMembersList();
            }
        });
        
        // 加载用户类型信息
        async function loadUserTypes() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/user-types`);
                if (response.ok) {
                    const data = await response.json();
                    agentAccounts = new Set(data.agentAccounts || []);
                    console.log('业务员账户信息加载成功:', agentAccounts);
                }
            } catch (error) {
                console.error('加载用户类型信息失败:', error);
            }
        }
        
        // 获取用户类型
        function getUserType(user) {
            // 首先检查是否为管理员类型
            if (user.IsAdmin || user.Phone === 'useradmin') {
                // 根据UserType字段区分超级管理员和普通管理员
                if (user.UserType === 'super_admin') {
                    return { type: 'super_admin', label: '超级管理员', class: 'bg-danger' };
                } else {
                    return { type: 'admin', label: '普通管理员', class: 'bg-warning' };
                }
            } else if (agentAccounts.has(user.Username) || agentAccounts.has(user.Phone)) {
                return { type: 'agent', label: '业务员', class: 'bg-primary' };
            } else {
                return { type: 'customer', label: '客户', class: 'bg-success' };
            }
        }
        
        // 加载会员列表
        async function loadMembersList() {
            try {
                console.log('开始加载会员列表...');
                
                // 先加载用户类型信息
                await loadUserTypes();
                
                const response = await fetch(`${API_BASE_URL}/api/admin/users?page=1&pageSize=1000`); // 获取所有用户
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // 过滤掉管理员账户，只保留普通注册会员
                const allUsers = data.users || [];
                membersData = allUsers.filter(user => {
                    // 排除管理员账户：IsAdmin为true或Phone为'useradmin'的用户
                    return !user.IsAdmin && user.Phone !== 'useradmin';
                });
                
                filteredMembersData = [...membersData];
                
                // 更新总数显示（只计算过滤后的会员数量）
                document.getElementById('memberTotalCount').textContent = membersData.length;
                
                console.log(`加载完成：总用户数 ${allUsers.length}，会员数 ${membersData.length}`);
                
                // 渲染会员列表
                renderMembersList();
                renderMembersPagination();
                
            } catch (error) {
                console.error('加载会员列表失败:', error);
                document.getElementById('membersList').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="mt-2">加载会员数据失败: ${error.message}</div>
                            <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadMembersList()">重试</button>
                        </td>
                    </tr>
                `;
            }
        }
        
        // 渲染会员列表
        function renderMembersList() {
            const tbody = document.getElementById('membersList');
            if (!tbody) return;
            
            if (filteredMembersData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            <i class="fas fa-users"></i>
                            <div class="mt-2">暂无会员数据</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // 计算分页数据
            const startIndex = (currentMemberPage - 1) * memberPageSize;
            const endIndex = startIndex + memberPageSize;
            const pageData = filteredMembersData.slice(startIndex, endIndex);
            
            const rows = pageData.map(member => {
                const registerTime = new Date(member.RegisterTime).toLocaleDateString('zh-CN');
                const isActive = member.IsActive !== false;
                const userType = getUserType(member);
                
                // 显示账号（优先显示用户名，其次手机号）
                const account = member.Username || member.Phone || '未设置';
                
                // 显示密码（注意：实际项目中不应该显示明文密码，这里按用户要求显示）
                const password = member.passwordHash || member.Password || member.password || member.PasswordHash || '未设置';
                
                // 显示邀请码
                const inviteCode = member.InviteCodeUsed || '无';
                
                // 客户数（暂时显示为0，后续可以从其他数据源获取）
                const customerCount = member.CustomerCount || 0;
                
                return `
                    <tr>
                        <td><strong>${account}</strong></td>
                        <td><span class="text-danger">${password}</span></td>
                        <td><span class="badge bg-primary">${inviteCode}</span></td>
                        <td><span class="badge bg-info">${customerCount}</span></td>
                        <td><small class="text-muted">${registerTime}</small></td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewMemberDetails('${member.Id}')" title="查看详情">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="editMemberVip('${member.Id}')" title="调整VIP等级">
                                    <i class="fas fa-crown"></i>
                                </button>
                                <button class="btn btn-outline-${isActive ? 'danger' : 'success'} btn-sm" onclick="toggleMemberStatus('${member.Id}', ${!isActive})" title="${isActive ? '禁用' : '启用'}用户">
                                    <i class="fas fa-${isActive ? 'ban' : 'check'}"></i>
                                </button>
                                ${userType.type !== 'admin' ? `
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteMember('${member.Id}', '${member.NickName || member.Phone}')" title="删除用户">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }
        
        // 渲染分页控件
        function renderMembersPagination() {
            const totalPages = Math.ceil(filteredMembersData.length / memberPageSize);
            const pagination = document.getElementById('memberPagination');
            
            if (!pagination || totalPages <= 1) {
                if (pagination) pagination.innerHTML = '';
                return;
            }
            
            let paginationHtml = '';
            
            // 上一页
            paginationHtml += `
                <li class="page-item ${currentMemberPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changeMemberPage(${currentMemberPage - 1})">上一页</a>
                </li>
            `;
            
            // 页码
            const startPage = Math.max(1, currentMemberPage - 2);
            const endPage = Math.min(totalPages, currentMemberPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentMemberPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changeMemberPage(${i})">${i}</a>
                    </li>
                `;
            }
            
            // 下一页
            paginationHtml += `
                <li class="page-item ${currentMemberPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changeMemberPage(${currentMemberPage + 1})">下一页</a>
                </li>
            `;
            
            pagination.innerHTML = paginationHtml;
        }
        
        // 切换页面
        function changeMemberPage(page) {
            const totalPages = Math.ceil(filteredMembersData.length / memberPageSize);
            if (page < 1 || page > totalPages) return;
            
            currentMemberPage = page;
            renderMembersList();
            renderMembersPagination();
        }
        
        // 改变每页显示数量
        function changeMemberPageSize() {
            const select = document.getElementById('memberPageSize');
            memberPageSize = parseInt(select.value);
            currentMemberPage = 1;
            renderMembersList();
            renderMembersPagination();
        }
        
        // 搜索会员
        function searchMembers() {
            const searchInput = document.getElementById('memberSearchInput');
            memberSearchTerm = searchInput.value.trim();
            filterMembers();
        }
        
        // 处理搜索输入
        function handleMemberSearch(event) {
            if (event.key === 'Enter') {
                searchMembers();
            }
        }
        
        // 筛选会员
        function filterMembers() {
            const statusFilter = document.getElementById('memberStatusFilter').value;
            const vipFilter = document.getElementById('memberVipFilter').value;
            
            memberStatusFilter = statusFilter;
            memberVipFilter = vipFilter;
            
            filteredMembersData = membersData.filter(member => {
                // 确保排除管理员账户（双重保护）
                const isNotAdmin = !member.IsAdmin && member.Phone !== 'useradmin';
                
                // 搜索筛选
                const matchesSearch = !memberSearchTerm || 
                    (member.Phone && member.Phone.includes(memberSearchTerm)) ||
                    (member.NickName && member.NickName.includes(memberSearchTerm));
                
                // 状态筛选
                const matchesStatus = !memberStatusFilter || 
                    (memberStatusFilter === 'true' && member.IsActive !== false) ||
                    (memberStatusFilter === 'false' && member.IsActive === false);
                
                // VIP等级筛选
                const matchesVip = !memberVipFilter || 
                    member.VipLevel == memberVipFilter;
                
                return isNotAdmin && matchesSearch && matchesStatus && matchesVip;
            });
            
            currentMemberPage = 1;
            renderMembersList();
            renderMembersPagination();
        }
        
        // 刷新会员列表
        function refreshMemberList() {
            // 重置筛选条件
            document.getElementById('memberSearchInput').value = '';
            document.getElementById('memberStatusFilter').value = '';
            document.getElementById('memberVipFilter').value = '';
            
            memberSearchTerm = '';
            memberStatusFilter = '';
            memberVipFilter = '';
            currentMemberPage = 1;
            
            // 重新加载数据
            loadMembersList();
        }
        
        // 查看会员详情
        function viewMemberDetails(memberId) {
            const member = membersData.find(m => m.Id === memberId);
            if (!member) {
                Swal.fire('错误', '未找到指定会员', 'error');
                return;
            }
            
            // 显示会员详情页面
            showMemberDetailsPage(member);
            showSection('member-details');
        }
        
        // 显示会员详情页面
        function showMemberDetailsPage(member) {
            const vipLevel = member.VipLevel || 1;
            const vipName = vipLevelNames[vipLevel] || `VIP ${vipLevel}`;
            const balance = parseFloat(member.CurrentBalance || 0);
            const frozenAmount = parseFloat(member.FrozenAmount || 0);
            const creditScore = member.CreditScore || 0;
            const registerTime = new Date(member.RegisterTime).toLocaleDateString('zh-CN');
            const lastLoginTime = member.LastLoginTime ? new Date(member.LastLoginTime).toLocaleDateString('zh-CN') : '从未登录';
            const isActive = member.IsActive !== false;
            const userType = getUserType(member);
            
            const detailsContent = document.getElementById('memberDetailsContent');
            const closeBtn = document.getElementById('closeMemberDetailsBtn');
            
            closeBtn.style.display = 'block';
            
            detailsContent.innerHTML = `
                <div class="row">
                    <!-- 基本信息卡片 -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-user"></i> 基本信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <div class="avatar-placeholder bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                        <i class="fas fa-user text-muted" style="font-size: 2rem;"></i>
                                    </div>
                                    <div class="mt-2">
                                        <span class="badge bg-primary fs-6 px-3 py-2">${vipName}</span>
                                        <span class="badge ${isActive ? 'bg-success' : 'bg-danger'} ms-2">${isActive ? '正常' : '禁用'}</span>
                                    </div>
                                </div>
                                
                                <table class="table table-borderless table-sm">
                                    <tr>
                                        <td><strong>用户ID:</strong></td>
                                        <td>${member.Id}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>手机号:</strong></td>
                                        <td>${member.Phone || '未设置'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>昵称:</strong></td>
                                        <td>${member.NickName || '未设置'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>用户名:</strong></td>
                                        <td>${member.Username || '未设置'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>用户类型:</strong></td>
                                        <td><span class="badge ${userType.class}">${userType.label}</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>注册时间:</strong></td>
                                        <td>${registerTime}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>最后登录:</strong></td>
                                        <td>${lastLoginTime}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 财务信息卡片 -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-wallet"></i> 财务信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center mb-3">
                                    <div class="col-6">
                                        <div class="border rounded p-3">
                                            <div class="text-success fw-bold fs-4">¥${balance.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</div>
                                            <small class="text-muted">当前余额</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-3">
                                            <div class="text-warning fw-bold fs-4">¥${frozenAmount.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</div>
                                            <small class="text-muted">冻结金额</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <table class="table table-borderless table-sm">
                                    <tr>
                                        <td><strong>信用分:</strong></td>
                                        <td><span class="badge bg-info">${creditScore}</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>总资产:</strong></td>
                                        <td class="text-primary fw-bold">¥${(balance + frozenAmount).toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VIP信息卡片 -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-crown"></i> VIP信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <span class="badge bg-primary fs-5 px-4 py-3">${vipName}</span>
                                </div>
                                
                                <div id="vipBenefitsInfo">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                        <div class="mt-2">正在加载VIP权益...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 邀请信息卡片 -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-users"></i> 邀请信息</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-borderless table-sm">
                                    <tr>
                                        <td><strong>我的邀请码:</strong></td>
                                        <td>
                                            ${member.MyInviteCode ? 
                                                `<span class="badge bg-primary">${member.MyInviteCode}</span>` : 
                                                '<span class="text-muted">未设置</span>'
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>使用邀请码:</strong></td>
                                        <td>
                                            ${member.InviteCodeUsed ? 
                                                `<span class="badge bg-success">${member.InviteCodeUsed}</span>` : 
                                                '<span class="text-muted">未使用</span>'
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>邀请人ID:</strong></td>
                                        <td>${member.InviterId || '<span class="text-muted">无</span>'}</td>
                                    </tr>
                                </table>
                                
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewInviteHistory('${member.Id}')">
                                        <i class="fas fa-history"></i> 邀请记录
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-cogs"></i> 操作</h6>
                            </div>
                            <div class="card-body">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-warning" onclick="editMemberVip('${member.Id}')">
                                        <i class="fas fa-crown"></i> 调整VIP等级
                                    </button>
                                    <button class="btn btn-outline-${isActive ? 'danger' : 'success'}" onclick="toggleMemberStatus('${member.Id}', ${!isActive})">
                                        <i class="fas fa-${isActive ? 'ban' : 'check'}"></i> ${isActive ? '禁用' : '启用'}用户
                                    </button>
                                    <button class="btn btn-outline-info" onclick="viewMemberOrders('${member.Id}')">
                                        <i class="fas fa-shopping-cart"></i> 查看订单
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="refreshMemberDetails('${member.Id}')">
                                        <i class="fas fa-sync-alt"></i> 刷新
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 加载VIP权益信息
            loadMemberVipBenefits(vipLevel);
        }
        
        // 加载会员VIP权益信息
        async function loadMemberVipBenefits(vipLevel) {
            try {
                // 从VIP等级数据中获取权益信息
                const vipInfo = vipLevelsData.find(v => v.level === vipLevel);
                const benefitsContainer = document.getElementById('vipBenefitsInfo');
                
                if (vipInfo && benefitsContainer) {
                    const benefitsHtml = `
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="text-success fw-bold">¥${(vipInfo.min_deposit || 0).toLocaleString()}</div>
                                    <small class="text-muted">最低充值</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="text-warning fw-bold">${((vipInfo.commission_rate || 0) * 100).toFixed(1)}%</div>
                                    <small class="text-muted">佣金率</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="text-primary fw-bold">${vipInfo.daily_order_limit || 0}</div>
                                    <small class="text-muted">每日订单</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="text-info fw-bold">¥${(vipInfo.withdrawal_limit || 0).toLocaleString()}</div>
                                    <small class="text-muted">提现限额</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6>专享权益:</h6>
                            ${(vipInfo.benefits || []).map((benefit, index) => 
                                `<div class="alert alert-light py-2 mb-1">
                                    <small><strong>${index + 1}.</strong> ${benefit}</small>
                                </div>`
                            ).join('') || '<div class="text-muted">暂无权益信息</div>'}
                        </div>
                    `;
                    
                    benefitsContainer.innerHTML = benefitsHtml;
                }
            } catch (error) {
                console.error('加载VIP权益失败:', error);
                const benefitsContainer = document.getElementById('vipBenefitsInfo');
                if (benefitsContainer) {
                    benefitsContainer.innerHTML = '<div class="text-danger">加载VIP权益失败</div>';
                }
            }
        }
        
        // 关闭会员详情
        function closeMemberDetails() {
            const detailsContent = document.getElementById('memberDetailsContent');
            const closeBtn = document.getElementById('closeMemberDetailsBtn');
            
            closeBtn.style.display = 'none';
            
            detailsContent.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-user-circle text-muted" style="font-size: 4rem;"></i>
                    <p class="text-muted mt-3">请从会员列表中选择一个会员查看详细信息</p>
                    <button class="btn btn-primary" onclick="showSection('member-list')">
                        <i class="fas fa-list"></i> 返回会员列表
                    </button>
                </div>
            `;
            
            showSection('member-list');
        }
        
        // 刷新会员详情
        function refreshMemberDetails(memberId) {
            const member = membersData.find(m => m.Id === memberId);
            if (member) {
                showMemberDetailsPage(member);
            }
        }
        
        // 查看邀请记录
        function viewInviteHistory(memberId) {
            Swal.fire({
                title: '邀请记录',
                text: '功能开发中...',
                icon: 'info'
            });
        }
        
        // 查看会员订单
        function viewMemberOrders(memberId) {
            Swal.fire({
                title: '会员订单',
                text: '功能开发中...',
                icon: 'info'
            });
        }
        
        // 编辑会员VIP等级
        function editMemberVip(memberId) {
            const member = membersData.find(m => m.Id === memberId);
            if (!member) {
                Swal.fire('错误', '未找到指定会员', 'error');
                return;
            }
            
            const currentVip = member.VipLevel || 1;
            
            Swal.fire({
                title: `调整VIP等级 - ${member.NickName || member.Phone}`,
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label class="form-label">当前VIP等级: <span class="badge bg-primary">${vipLevelNames[currentVip]}</span></label>
                        </div>
                        <div class="mb-3">
                            <label for="newVipLevel" class="form-label">新VIP等级</label>
                            <select id="newVipLevel" class="form-select">
                                <option value="1" ${currentVip === 1 ? 'selected' : ''}>VIP 1 🥉</option>
                                <option value="2" ${currentVip === 2 ? 'selected' : ''}>VIP 2 🥈</option>
                                <option value="3" ${currentVip === 3 ? 'selected' : ''}>VIP 3 🥇</option>
                                <option value="4" ${currentVip === 4 ? 'selected' : ''}>VIP 4 👑</option>
                            </select>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '确认调整',
                cancelButtonText: '取消',
                preConfirm: () => {
                    const newVipLevel = parseInt(document.getElementById('newVipLevel').value);
                    if (newVipLevel === currentVip) {
                        Swal.showValidationMessage('请选择不同的VIP等级');
                        return false;
                    }
                    return newVipLevel;
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await updateMemberVipLevel(memberId, result.value);
                }
            });
        }
        
        // 更新会员VIP等级
        async function updateMemberVipLevel(memberId, newVipLevel) {
            try {
                // 这里应该调用后端API更新VIP等级
                // 暂时模拟更新本地数据
                const memberIndex = membersData.findIndex(m => m.Id === memberId);
                if (memberIndex !== -1) {
                    membersData[memberIndex].VipLevel = newVipLevel;
                    
                    // 重新筛选和渲染
                    filterMembers();
                    
                    Swal.fire('成功', `VIP等级已调整为 ${vipLevelNames[newVipLevel]}`, 'success');
                }
            } catch (error) {
                console.error('更新VIP等级失败:', error);
                Swal.fire('错误', '更新VIP等级失败', 'error');
            }
        }
        
        // 切换会员状态
        async function toggleMemberStatus(memberId, newStatus) {
            const member = membersData.find(m => m.Id === memberId);
            if (!member) {
                Swal.fire('错误', '未找到指定会员', 'error');
                return;
            }
            
            const action = newStatus ? '启用' : '禁用';
            
            Swal.fire({
                title: `确认${action}会员`,
                text: `确定要${action}会员 "${member.NickName || member.Phone}" 吗？`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `确认${action}`,
                cancelButtonText: '取消',
                confirmButtonColor: newStatus ? '#28a745' : '#dc3545'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        // 这里应该调用后端API更新状态
                        // 暂时模拟更新本地数据
                        const memberIndex = membersData.findIndex(m => m.Id === memberId);
                        if (memberIndex !== -1) {
                            membersData[memberIndex].IsActive = newStatus;
                            
                            // 重新筛选和渲染
                            filterMembers();
                            
                            Swal.fire('成功', `会员已${action}`, 'success');
                        }
                    } catch (error) {
                        console.error('更新会员状态失败:', error);
                        Swal.fire('错误', '更新会员状态失败', 'error');
                    }
                }
            });
        }

        // 删除会员
        async function deleteMember(memberId, memberName) {
            const member = membersData.find(m => m.Id == memberId);
            if (!member) {
                Swal.fire('错误', '未找到指定会员', 'error');
                return;
            }
            
            // 检查是否为管理员
            const userType = getUserType(member);
            if (userType.type === 'admin') {
                Swal.fire('错误', '不能删除管理员账户', 'error');
                return;
            }
            
            Swal.fire({
                title: '确认删除会员',
                html: `
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        </div>
                        <p><strong>会员信息：</strong></p>
                        <p>用户ID: <span class="badge bg-light text-dark">${member.Id}</span></p>
                        <p>昵称: <strong>${member.NickName || '未设置'}</strong></p>
                        <p>手机号: <strong>${member.Phone || '未设置'}</strong></p>
                        <p>用户类型: <span class="badge ${userType.class}">${userType.label}</span></p>
                        <div class="alert alert-danger mt-3">
                            <strong>警告：</strong>删除操作无法撤销！<br>
                            将同时清理该用户的所有相关数据。
                        </div>
                        <p class="text-danger">确定要删除这个会员吗？</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '确认删除',
                cancelButtonText: '取消',
                confirmButtonColor: '#dc3545',
                focusCancel: true
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // 二次确认
                    Swal.fire({
                        title: '最终确认',
                        text: '请再次确认删除操作，此操作不可撤销！',
                        icon: 'error',
                        showCancelButton: true,
                        confirmButtonText: '我确定要删除',
                        cancelButtonText: '取消',
                        confirmButtonColor: '#dc3545'
                    }).then(async (finalResult) => {
                        if (finalResult.isConfirmed) {
                            try {
                                Swal.fire({
                                    title: '删除中...',
                                    text: '正在删除会员数据，请稍候...',
                                    allowOutsideClick: false,
                                    didOpen: () => {
                                        Swal.showLoading();
                                    }
                                });
                                
                                console.log(`开始删除用户 ID: ${memberId}`);
                                
                                const response = await fetch(`${API_BASE_URL}/api/admin/users/${memberId}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                
                                console.log(`删除API响应状态: ${response.status} ${response.statusText}`);
                                console.log('响应对象:', response);
                                
                                if (response.ok) {
                                    console.log('删除请求成功，开始处理响应...');
                                    let result = { message: '删除成功' };
                                    try {
                                        result = await response.json();
                                        console.log('成功解析JSON响应:', result);
                                    } catch (jsonError) {
                                        console.log('JSON解析失败，使用默认成功消息:', jsonError);
                                    }
                                    // 从本地数据中移除
                                    const memberIndex = membersData.findIndex(m => m.Id == memberId);
                                    if (memberIndex !== -1) {
                                        membersData.splice(memberIndex, 1);
                                    }
                                    
                                    // 重新筛选和渲染
                                    filterMembers();
                                    
                                    // 更新总数显示
                                    document.getElementById('memberTotalCount').textContent = membersData.length;
                                    
                                    Swal.fire({
                                        title: '删除成功',
                                        text: '会员已成功删除',
                                        icon: 'success',
                                        timer: 2000,
                                        showConfirmButton: false
                                    });
                                } else {
                                    console.log('删除请求失败，状态码:', response.status);
                                    let errorResult = { message: '删除失败' };
                                    try {
                                        errorResult = await response.json();
                                        console.log('错误响应内容:', errorResult);
                                    } catch (jsonError) {
                                        console.log('错误响应JSON解析失败，使用默认错误消息:', jsonError);
                                    }
                                    throw new Error(errorResult.message || '删除失败');
                                }
                            } catch (error) {
                                console.error('删除会员失败:', error);
                                console.error('错误详情:', error.stack);
                                Swal.fire({
                                    title: '删除失败',
                                    text: error.message || '删除会员时发生错误',
                                    icon: 'error'
                                });
                            }
                        }
                    });
                }
            });
        }

        // 业务员管理相关变量
        let staffData = [];
        let currentEditingStaffId = null;

        // 显示添加业务员模态框
        function showAddStaffModal() {
            currentEditingStaffId = null;
            document.getElementById('staffModalLabel').textContent = '添加业务员';
            document.getElementById('staffForm').reset();
            document.getElementById('staffStatus').value = 'active';
            
            // 自动生成邀请码
            generateInviteCode();
            
            const modal = new bootstrap.Modal(document.getElementById('staffModal'));
            modal.show();
        }

        // 显示编辑业务员模态框
        function showEditStaffModal(staffId) {
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) {
                Swal.fire({
                    title: '错误',
                    text: '业务员不存在',
                    icon: 'error'
                });
                return;
            }

            currentEditingStaffId = staffId;
            document.getElementById('staffModalLabel').textContent = '编辑业务员';
            
            // 填充表单数据
            document.getElementById('staffUsername').value = staff.username || '';
            document.getElementById('staffNickname').value = staff.nickname || '';
            document.getElementById('staffPassword').value = ''; // 密码不显示
            document.getElementById('staffInviteCode').value = staff.inviteCode || '';
            document.getElementById('staffStatus').value = staff.isActive ? 'active' : 'inactive';
            
            const modal = new bootstrap.Modal(document.getElementById('staffModal'));
            modal.show();
        }

        // 生成邀请码
        async function generateInviteCode() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/salesperson/generate-invite-code`);
                if (response.ok) {
                    let result = { success: false, message: '邀请码响应解析失败' };
                    try {
                        const responseText = await response.text();
                        if (responseText.trim()) {
                            result = JSON.parse(responseText);
                        }
                    } catch (error) {
                        console.error('解析邀请码响应JSON失败:', error);
                        // 生成一个默认邀请码
                        const defaultCode = 'INV' + Date.now().toString().slice(-6);
                        document.getElementById('staffInviteCode').value = defaultCode;
                        return;
                    }
                    
                    if (result.success && result.data) {
                        document.getElementById('staffInviteCode').value = result.data.inviteCode;
                    } else {
                        throw new Error(result.message || '生成邀请码失败');
                    }
                } else {
                    throw new Error('生成邀请码失败');
                }
            } catch (error) {
                console.error('生成邀请码失败:', error);
                Swal.fire({
                    title: '生成失败',
                    text: '无法生成邀请码，请手动输入',
                    icon: 'warning'
                });
            }
        }

        // 保存业务员
        async function saveStaff() {
            const form = document.getElementById('staffForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = {
                username: document.getElementById('staffUsername').value.trim(),
                nickname: document.getElementById('staffNickname').value.trim(),
                password: document.getElementById('staffPassword').value,
                inviteCode: document.getElementById('staffInviteCode').value.trim()
            };

            // 验证邀请码格式
            if (!/^\d{6}$/.test(formData.inviteCode)) {
                Swal.fire({
                    title: '格式错误',
                    text: '邀请码必须是6位数字',
                    icon: 'error'
                });
                return;
            }

            // 验证密码长度（新增时必须有密码）
            if (!currentEditingStaffId && formData.password.length < 6) {
                Swal.fire({
                    title: '密码错误',
                    text: '密码至少需要6位字符',
                    icon: 'error'
                });
                return;
            }

            try {
                Swal.fire({
                    title: '保存中...',
                    text: '正在保存业务员信息',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                let response;
                if (currentEditingStaffId) {
                    // 编辑模式
                    const updateData = {
                        username: formData.username,
                        nickname: formData.nickname,
                        inviteCode: formData.inviteCode
                    };
                    
                    // 如果有新密码，则包含密码
                    if (formData.password) {
                        updateData.password = formData.password;
                    }

                    response = await fetch(`${API_BASE_URL}/api/salesperson/update/${currentEditingStaffId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                } else {
                    // 新增模式 - 修复字段映射
                    response = await fetch(`${API_BASE_URL}/api/salesperson/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: formData.username,
                            nickname: formData.nickname,
                            password: formData.password,
                            inviteCode: formData.inviteCode,
                            commissionRate: 0.05 // 5%佣金率
                        })
                    });
                }

                let result = { success: false, message: '响应解析失败' };
                try {
                    const responseText = await response.text();
                    if (responseText.trim()) {
                        result = JSON.parse(responseText);
                    }
                } catch (error) {
                    console.error('解析响应JSON失败:', error);
                    throw new Error('服务器响应格式错误');
                }

                if (response.ok && result.success) {
                    // 确保数据刷新
                    await loadStaffList();
                    
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('staffModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // 显示成功消息
                    Swal.fire({
                        title: '保存成功',
                        text: currentEditingStaffId ? '业务员信息已更新' : '业务员已添加',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    
                    // 重置编辑状态
                    currentEditingStaffId = null;
                } else {
                    throw new Error(result.message || '保存失败');
                }
            } catch (error) {
                console.error('保存业务员失败:', error);
                Swal.fire({
                    title: '保存失败',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // 基础信息表单提交
        document.getElementById('basic-info-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            Swal.fire({
                title: '保存成功',
                text: '基础信息已更新',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        });

        // ==================== LOGO管理功能 ====================
        
        // LOGO设置变量
        let currentLogoSettings = {
            type: 'combined',
            text: 'SheIn1323',
            fontSize: 24,
            fontColor: '#333333',
            fontWeight: '400',
            fontFamily: "'Microsoft YaHei', sans-serif",
            imageUrl: '',
            imagePosition: 'left'
        };

        // 页面加载时初始化LOGO设置
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentLogoSettings();
            setupLogoEventListeners();
            updateLogoPreview();
            
            // 初始化区号管理
            initCountryCodeManagement();
        });

        // 设置LOGO相关事件监听器
        function setupLogoEventListeners() {
            // LOGO类型切换
            document.querySelectorAll('input[name="logoType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentLogoSettings.type = this.value;
                    toggleLogoSettingsSections();
                    updateLogoPreview();
                });
            });

            // 文字设置监听器
            document.getElementById('logoText').addEventListener('input', function() {
                currentLogoSettings.text = this.value;
                updateLogoPreview();
            });

            document.getElementById('fontSize').addEventListener('input', function() {
                currentLogoSettings.fontSize = parseInt(this.value);
                updateLogoPreview();
            });

            document.getElementById('fontColor').addEventListener('change', function() {
                currentLogoSettings.fontColor = this.value;
                updateLogoPreview();
            });

            document.getElementById('fontWeight').addEventListener('change', function() {
                currentLogoSettings.fontWeight = this.value;
                updateLogoPreview();
            });

            document.getElementById('fontFamily').addEventListener('change', function() {
                currentLogoSettings.fontFamily = this.value;
                updateLogoPreview();
            });

            // 图片位置监听器
            document.querySelectorAll('input[name="imagePosition"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentLogoSettings.imagePosition = this.value;
                    updateLogoPreview();
                });
            });
        }

        // 切换LOGO设置区域显示
        function toggleLogoSettingsSections() {
            const textSettings = document.getElementById('textSettings');
            const imageSettings = document.getElementById('imageSettings');
            const type = currentLogoSettings.type;

            if (type === 'text') {
                textSettings.style.display = 'block';
                imageSettings.style.display = 'none';
            } else if (type === 'image') {
                textSettings.style.display = 'none';
                imageSettings.style.display = 'block';
            } else if (type === 'combined') {
                textSettings.style.display = 'block';
                imageSettings.style.display = 'block';
            }
        }

        // 更新字体大小显示
        function updateFontSizeDisplay(value) {
            document.getElementById('fontSizeDisplay').textContent = value + 'px';
            currentLogoSettings.fontSize = parseInt(value);
            updateLogoPreview();
        }

        // 处理LOGO图片上传
        function handleLogoImageUpload(input) {
            const file = input.files[0];
            if (file) {
                // 验证文件类型
                if (!file.type.startsWith('image/')) {
                    Swal.fire({
                        title: '错误',
                        text: '请选择有效的图片文件',
                        icon: 'error'
                    });
                    return;
                }

                // 验证文件大小 (2MB)
                if (file.size > 2 * 1024 * 1024) {
                    Swal.fire({
                        title: '错误',
                        text: '图片文件大小不能超过2MB',
                        icon: 'error'
                    });
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    currentLogoSettings.imageUrl = e.target.result;
                    showCurrentLogoImage(e.target.result);
                    updateLogoPreview();
                };
                reader.readAsDataURL(file);
            }
        }

        // 显示当前LOGO图片
        function showCurrentLogoImage(imageUrl) {
            const currentLogoImage = document.getElementById('currentLogoImage');
            const logoImagePreview = document.getElementById('logoImagePreview');
            
            logoImagePreview.src = imageUrl;
            currentLogoImage.style.display = 'block';
        }

        // 删除LOGO图片
        function removeLogoImage() {
            currentLogoSettings.imageUrl = '';
            document.getElementById('currentLogoImage').style.display = 'none';
            document.getElementById('logoImageFile').value = '';
            updateLogoPreview();
        }

        // 更新LOGO预览
        function updateLogoPreview() {
            const previewContainer = document.getElementById('logoPreviewContent');
            const type = currentLogoSettings.type;
            
            let previewHTML = '';

            if (type === 'text') {
                // 纯文字LOGO
                previewHTML = `
                    <span style="
                        font-size: ${currentLogoSettings.fontSize}px;
                        color: ${currentLogoSettings.fontColor};
                        font-weight: ${currentLogoSettings.fontWeight};
                        font-family: ${currentLogoSettings.fontFamily};
                    ">${currentLogoSettings.text || '请输入LOGO文字'}</span>
                `;
            } else if (type === 'image') {
                // 纯图片LOGO
                if (currentLogoSettings.imageUrl) {
                    previewHTML = `<img src="${currentLogoSettings.imageUrl}" style="max-height: 60px;" alt="LOGO">`;
                } else {
                    previewHTML = '<div class="text-muted"><i class="fas fa-image fa-2x"></i><p class="mt-2 mb-0">请上传LOGO图片</p></div>';
                }
            } else if (type === 'combined') {
                // 组合LOGO
                const textElement = `
                    <span style="
                        font-size: ${currentLogoSettings.fontSize}px;
                        color: ${currentLogoSettings.fontColor};
                        font-weight: ${currentLogoSettings.fontWeight};
                        font-family: ${currentLogoSettings.fontFamily};
                        margin: 0 10px;
                    ">${currentLogoSettings.text || '请输入LOGO文字'}</span>
                `;
                
                const imageElement = currentLogoSettings.imageUrl ? 
                    `<img src="${currentLogoSettings.imageUrl}" style="max-height: 60px;" alt="LOGO">` : 
                    '<div class="text-muted" style="margin: 0 10px;"><i class="fas fa-image"></i> 请上传图片</div>';

                // 根据图片位置生成不同的布局
                switch (currentLogoSettings.imagePosition) {
                    case 'left':
                        previewHTML = `<div class="d-flex align-items-center">${imageElement}${textElement}</div>`;
                        break;
                    case 'right':
                        previewHTML = `<div class="d-flex align-items-center">${textElement}${imageElement}</div>`;
                        break;
                    case 'top':
                        previewHTML = `<div class="d-flex flex-column align-items-center">${imageElement}${textElement}</div>`;
                        break;
                    case 'center':
                        previewHTML = `
                            <div class="d-flex align-items-center justify-content-center position-relative">
                                <div class="position-absolute" style="z-index: 1;">${imageElement}</div>
                                <div style="z-index: 2; background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 5px;">${textElement}</div>
                            </div>
                        `;
                        break;
                    case 'bottom':
                        previewHTML = `<div class="d-flex flex-column align-items-center">${textElement}${imageElement}</div>`;
                        break;
                    default:
                        previewHTML = `<div class="d-flex align-items-center">${imageElement}${textElement}</div>`;
                }
            }

            previewContainer.innerHTML = previewHTML;
        }

        // 预览LOGO效果
        function previewLogo() {
            updateLogoPreview();
            Swal.fire({
                title: 'LOGO预览',
                html: document.getElementById('logoPreviewContent').innerHTML,
                icon: 'info',
                confirmButtonText: '确定'
            });
        }

        // 保存LOGO设置
        async function saveLogoSettings() {
            try {
                // 显示加载状态
                Swal.fire({
                    title: '保存中...',
                    text: '正在保存LOGO设置',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 如果有图片需要上传
                let imageUrl = currentLogoSettings.imageUrl;
                if (imageUrl && imageUrl.startsWith('data:')) {
                    imageUrl = await uploadLogoImage(imageUrl);
                }

                // 准备保存数据
                const logoData = {
                    type: currentLogoSettings.type,
                    text: currentLogoSettings.text,
                    fontSize: currentLogoSettings.fontSize,
                    fontColor: currentLogoSettings.fontColor,
                    fontWeight: currentLogoSettings.fontWeight,
                    fontFamily: currentLogoSettings.fontFamily,
                    imageUrl: imageUrl,
                    imagePosition: currentLogoSettings.imagePosition
                };

                // 调用API保存
                const response = await fetch(`${API_BASE_URL}/api/admin/logo-settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(logoData)
                });

                if (response.ok) {
                    Swal.fire({
                        title: '保存成功',
                        text: 'LOGO设置已保存，首页将显示新的LOGO',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    const errorData = await response.json().catch(() => ({ message: '未知错误' }));
                    throw new Error(`保存失败: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                console.error('保存LOGO设置失败:', error);
                Swal.fire({
                    title: '保存失败',
                    text: error.message || '保存LOGO设置时出现错误，请重试',
                    icon: 'error'
                });
            }
        }

        // 上传LOGO图片
        async function uploadLogoImage(dataUrl) {
            try {
                // 将base64转换为blob
                const response = await fetch(dataUrl);
                const blob = await response.blob();
                
                // 创建FormData
                const formData = new FormData();
                formData.append('logo', blob, 'logo.png');

                // 上传图片
                const uploadResponse = await fetch(`${API_BASE_URL}/api/admin/upload-logo`, {
                    method: 'POST',
                    body: formData
                });

                if (uploadResponse.ok) {
                    const result = await uploadResponse.json();
                    return result.imageUrl;
                } else {
                    throw new Error('图片上传失败');
                }
            } catch (error) {
                console.error('上传图片失败:', error);
                throw error;
            }
        }

        // 加载当前LOGO设置
        async function loadCurrentLogoSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/logo-settings`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // 更新设置
                    currentLogoSettings = {
                        type: data.type || 'combined',
                        text: data.text || 'SheIn1323',
                        fontSize: data.fontSize || 24,
                        fontColor: data.fontColor || '#333333',
                        fontWeight: data.fontWeight || '400',
                        fontFamily: data.fontFamily || "'Microsoft YaHei', sans-serif",
                        imageUrl: data.imageUrl || '',
                        imagePosition: data.imagePosition || 'left'
                    };

                    // 更新界面
                    updateLogoFormFields();
                    toggleLogoSettingsSections();
                    updateLogoPreview();
                }
            } catch (error) {
                console.error('加载LOGO设置失败:', error);
            }
        }

        // 更新表单字段
        function updateLogoFormFields() {
            // 设置LOGO类型
            document.querySelector(`input[name="logoType"][value="${currentLogoSettings.type}"]`).checked = true;
            
            // 设置文字相关字段
            document.getElementById('logoText').value = currentLogoSettings.text;
            document.getElementById('fontSize').value = currentLogoSettings.fontSize;
            document.getElementById('fontSizeDisplay').textContent = currentLogoSettings.fontSize + 'px';
            document.getElementById('fontColor').value = currentLogoSettings.fontColor;
            document.getElementById('fontWeight').value = currentLogoSettings.fontWeight;
            document.getElementById('fontFamily').value = currentLogoSettings.fontFamily;
            
            // 设置图片位置
            document.querySelector(`input[name="imagePosition"][value="${currentLogoSettings.imagePosition}"]`).checked = true;
            
            // 显示当前图片
            if (currentLogoSettings.imageUrl) {
                showCurrentLogoImage(currentLogoSettings.imageUrl);
            }
        }

        // 重置LOGO设置
        function resetLogoSettings() {
            Swal.fire({
                title: '确定要重置吗？',
                text: '这将清除所有LOGO设置',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '确定重置',
                cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 重置为默认设置
                    currentLogoSettings = {
                        type: 'combined',
                        text: 'SheIn1323',
                        fontSize: 24,
                        fontColor: '#333333',
                        fontWeight: '400',
                        fontFamily: "'Microsoft YaHei', sans-serif",
                        imageUrl: '',
                        imagePosition: 'left'
                    };
                    
                    updateLogoFormFields();
                    toggleLogoSettingsSections();
                    updateLogoPreview();
                    removeLogoImage();
                    
                    Swal.fire({
                        title: '重置成功',
                        text: 'LOGO设置已重置为默认值',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }


        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                Swal.fire({
                    title: '复制成功',
                    text: '地址已复制到剪贴板',
                    icon: 'success',
                    timer: 1000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            }).catch(err => {
                console.error('复制失败:', err);
                Swal.fire({
                    title: '复制失败',
                    text: '请手动复制地址',
                    icon: 'error',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        }

        // 格式化日期时间
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>

    <!-- 业务员添加/编辑模态框 -->
    <div class="modal fade" id="staffModal" tabindex="-1" aria-labelledby="staffModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staffModalLabel">添加业务员</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="staffForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="staffUsername" class="form-label">账号 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="staffUsername" required>
                                    <div class="form-text">用于登录的账号，不可重复</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="staffNickname" class="form-label">昵称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="staffNickname" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="staffPassword" class="form-label">密码 <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="staffPassword" required>
                                    <div class="form-text">至少6位字符</div>
                                </div>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="staffInviteCode" class="form-label">邀请码 <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="staffInviteCode" required maxlength="6" pattern="[0-9]{6}">
                                        <button type="button" class="btn btn-outline-secondary" onclick="generateInviteCode()">
                                            <i class="fas fa-sync-alt"></i> 自动生成
                                        </button>
                                    </div>
                                    <div class="form-text">6位数字邀请码，不可重复</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="staffStatus" class="form-label">状态</label>
                                    <select class="form-select" id="staffStatus">
                                        <option value="active">正常</option>
                                        <option value="inactive">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveStaff()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 客户列表模态框 -->
    <div class="modal fade" id="staffCustomersModal" tabindex="-1" aria-labelledby="staffCustomersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staffCustomersModalLabel">客户列表</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 搜索和筛选区域 -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchCustomers" placeholder="搜索客户（用户名、昵称、邮箱）" onkeyup="searchCustomers()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterCustomerStatus" onchange="searchCustomers()">
                                <option value="">全部状态</option>
                                <option value="active">正常</option>
                                <option value="inactive">禁用</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" onclick="showBatchTransferModal()" id="batchTransferBtn" disabled>
                                <i class="fas fa-exchange-alt"></i> 批量转移
                            </button>
                        </div>
                        <div class="col-md-2">
                            <div class="text-end">
                                <span class="badge bg-info fs-6" id="customerCount">0</span> 个客户
                            </div>
                        </div>
                    </div>

                    <!-- 客户列表表格 -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="selectAllCustomers" onchange="toggleSelectAllCustomers()">
                                    </th>
                                    <th>用户名</th>
                                    <th>昵称</th>
                                    <th>邮箱</th>
                                    <th>邀请码</th>
                                    <th>状态</th>
                                    <th>注册时间</th>
                                    <th width="120">操作</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                                <!-- 客户数据将在这里动态加载 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页 -->
                    <nav aria-label="客户列表分页" id="customersPagination" style="display: none;">
                        <ul class="pagination justify-content-center">
                            <!-- 分页按钮将在这里动态生成 -->
                        </ul>
                    </nav>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 单个客户转移模态框 -->
    <div class="modal fade" id="transferSingleCustomerModal" tabindex="-1" aria-labelledby="transferSingleCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transferSingleCustomerModalLabel">转移客户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">客户信息</label>
                        <div class="card">
                            <div class="card-body">
                                <div id="transferCustomerInfo"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="targetSalespersonSelect" class="form-label">目标业务员 <span class="text-danger">*</span></label>
                        <select class="form-select" id="targetSalespersonSelect" required>
                            <option value="">请选择目标业务员</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSingleTransfer()">确认转移</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量转移模态框 -->
    <div class="modal fade" id="batchTransferModal" tabindex="-1" aria-labelledby="batchTransferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="batchTransferModalLabel">批量转移客户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">选中的客户</label>
                        <div class="card">
                            <div class="card-body">
                                <div id="selectedCustomersInfo"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="batchTargetSalespersonSelect" class="form-label">目标业务员 <span class="text-danger">*</span></label>
                        <select class="form-select" id="batchTargetSalespersonSelect" required>
                            <option value="">请选择目标业务员</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmBatchTransfer()">确认转移</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑收款账户模态框 -->
    <div class="modal fade" id="paymentAccountModal" tabindex="-1" aria-labelledby="paymentAccountModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentAccountModalLabel">
                        <span id="addPaymentAccountTitle">添加收款账户</span>
                        <span id="editPaymentAccountTitle" style="display: none;">编辑收款账户</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentAccountForm">
                        <input type="hidden" id="paymentAccountId" name="id">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="walletName" class="form-label">钱包名称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="walletName" name="walletName" required>
                                    <div class="form-text">例如：主钱包、备用钱包等</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="accountType" class="form-label">数字货币类型 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="accountType" name="accountType" required>
                                        <option value="">请选择数字货币类型</option>
                                        <option value="USDT">USDT (泰达币)</option>
                                        <option value="BTC">BTC (比特币)</option>
                                        <option value="ETH">ETH (以太坊)</option>
                                        <option value="TRX">TRX (波场币)</option>
                                        <option value="BNB">BNB (币安币)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="networkType" class="form-label">网络类型 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="networkType" name="networkType" required>
                                        <option value="">请先选择数字货币类型</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="accountNumber" class="form-label">钱包地址 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="accountNumber" name="accountNumber" required>
                                    <div class="form-text" id="addressFormatHint">请输入有效的钱包地址</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="accountIdentifier" class="form-label">账户标识</label>
                                    <input type="text" class="form-control" id="accountIdentifier" name="accountIdentifier">
                                    <div class="form-text">可选，用于区分不同账户</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="accountStatus" class="form-label">状态 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="accountStatus" name="status" required>
                                        <option value="enabled">启用</option>
                                        <option value="disabled">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="isDefault" name="isDefault">
                                        <label class="form-check-label" for="isDefault">
                                            设为默认账户
                                        </label>
                                        <div class="form-text">默认账户将优先显示给用户</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="remarks" class="form-label">备注</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="3" placeholder="可选，添加备注信息"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="savePaymentAccount()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>


        // ==================== 收款账户辅助函数 ====================
        
        // 更新网络类型选项
        function updateNetworkOptions() {
            const accountType = document.getElementById('accountType').value;
            const networkSelect = document.getElementById('networkType');
            
            // 清空现有选项
            networkSelect.innerHTML = '<option value="">请选择网络类型</option>';
            
            // 根据数字货币类型添加对应的网络选项
            const networkOptions = {
                'USDT': [
                    { value: 'TRC20', text: 'TRC20 (波场网络)' },
                    { value: 'ERC20', text: 'ERC20 (以太坊网络)' },
                    { value: 'BEP20', text: 'BEP20 (币安智能链)' },
                    { value: 'OMNI', text: 'OMNI (比特币网络)' }
                ],
                'BTC': [
                    { value: 'BTC', text: 'Bitcoin Network' }
                ],
                'ETH': [
                    { value: 'ERC20', text: 'ERC20 (以太坊网络)' }
                ],
                'TRX': [
                    { value: 'TRC20', text: 'TRC20 (波场网络)' }
                ],
                'BNB': [
                    { value: 'BEP20', text: 'BEP20 (币安智能链)' },
                    { value: 'BEP2', text: 'BEP2 (币安链)' }
                ]
            };
            
            if (accountType && networkOptions[accountType]) {
                networkOptions[accountType].forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    networkSelect.appendChild(optionElement);
                });
            }
            
            // 更新地址格式提示
            updateAddressFormatHint();
        }

        // 更新地址格式提示
        function updateAddressFormatHint() {
            const accountType = document.getElementById('accountType').value;
            const hintElement = document.getElementById('addressFormatHint');
            
            const formatHints = {
                'USDT': '请输入有效的USDT钱包地址（根据网络类型而定）',
                'BTC': '请输入有效的比特币地址（以1、3或bc1开头）',
                'ETH': '请输入有效的以太坊地址（以0x开头，42位字符）',
                'TRX': '请输入有效的波场地址（以T开头，34位字符）',
                'BNB': '请输入有效的币安币地址（根据网络类型而定）'
            };
            
            hintElement.textContent = formatHints[accountType] || '请输入有效的钱包地址';
        }

        // 验证钱包地址格式
        function validateWalletAddress(address, accountType) {
            if (!address || !accountType) return false;
            
            const patterns = {
                'BTC': /^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$|^bc1[a-z0-9]{39,59}$/,
                'ETH': /^0x[a-fA-F0-9]{40}$/,
                'TRX': /^T[A-Za-z1-9]{33}$/,
                'USDT': /^[13T][a-km-zA-HJ-NP-Z1-9T]{25,34}$|^0x[a-fA-F0-9]{40}$|^bc1[a-z0-9]{39,59}$/,
                'BNB': /^bnb[a-z0-9]{39}$|^0x[a-fA-F0-9]{40}$/
            };
            
            const pattern = patterns[accountType];
            return pattern ? pattern.test(address) : true; // 如果没有定义模式，则认为有效
        }

        // 获取数字货币显示文本
        function getCryptoCurrencyText(accountType) {
            const currencyNames = {
                'USDT': 'USDT',
                'BTC': 'BTC',
                'ETH': 'ETH',
                'TRX': 'TRX',
                'BNB': 'BNB'
            };
            return currencyNames[accountType] || accountType;
        }

        // 获取网络类型显示文本
        function getNetworkTypeText(networkType) {
            const networkNames = {
                'TRC20': 'TRC20',
                'ERC20': 'ERC20',
                'BEP20': 'BEP20',
                'BEP2': 'BEP2',
                'OMNI': 'OMNI',
                'BTC': 'Bitcoin'
            };
            return networkNames[networkType] || networkType;
        }

        // 格式化钱包地址显示
        function formatWalletAddress(address) {
            if (!address) return '-';
            if (address.length <= 20) return address;
            return `${address.substring(0, 10)}...${address.substring(address.length - 10)}`;
        }

        // 初始化表单事件监听器
        function initializeFormEventListeners() {
            // 数字货币类型变化时更新网络选项
            const accountTypeSelect = document.getElementById('accountType');
            if (accountTypeSelect) {
                accountTypeSelect.addEventListener('change', updateNetworkOptions);
            }
            
            // 钱包地址输入时验证格式
            const accountNumberInput = document.getElementById('accountNumber');
            if (accountNumberInput) {
                accountNumberInput.addEventListener('blur', function() {
                    const accountType = document.getElementById('accountType').value;
                    const address = this.value;
                    
                    if (address && accountType) {
                        const isValid = validateWalletAddress(address, accountType);
                        if (!isValid) {
                            this.classList.add('is-invalid');
                        } else {
                            this.classList.remove('is-invalid');
                        }
                    }
                });
            }
        }

        // ==================== 权限控制功能 ====================
        
        // 当前用户权限信息
        let currentUserPermissions = {
            permissionLevel: 1, // 默认为普通管理员
            userType: 'admin',
            username: '管理员',
            hasSystemSettings: true,
            hasBackendAccess: true,
            hasSalespersonManagement: true
        };

        // 检查用户权限
        async function checkUserPermissions() {
            try {
                // 从localStorage获取当前用户信息
                const currentUser = localStorage.getItem('currentUser');
                const permissionLevel = localStorage.getItem('permissionLevel');
                
                if (currentUser && permissionLevel !== null) {
                    const user = JSON.parse(currentUser);
                    const level = parseInt(permissionLevel);
                    
                    // 根据权限等级设置权限
                    currentUserPermissions = {
                        permissionLevel: level,
                        userType: getUserTypeByLevel(level),
                        username: user.NickName || user.Phone || '用户',
                        hasSystemSettings: level <= 1, // 管理员(1)可以访问系统设置
                        hasBackendAccess: level <= 1, // 管理员(1)可以访问后台
                        hasSalespersonManagement: level <= 1 // 管理员(1)可以管理业务员
                    };
                } else {
                    // 如果没有权限信息，尝试从后端获取
                    const response = await fetch(`${API_BASE_URL}/api/admin/permissions/check?resource=all`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        currentUserPermissions = {
                            permissionLevel: result.permissionLevel || 1,
                            userType: result.userType || 'admin',
                            username: result.username || '管理员',
                            hasSystemSettings: (result.permissionLevel || 1) <= 1,
                            hasBackendAccess: (result.permissionLevel || 1) <= 1,
                            hasSalespersonManagement: (result.permissionLevel || 1) <= 1
                        };
                    }
                }
                
                // 应用权限控制
                applyPermissionControls();
                
                console.log('用户权限信息:', currentUserPermissions);
            } catch (error) {
                console.error('权限检查出错:', error);
                // 出错时默认为普通管理员权限
            }
        }

        // 根据权限等级获取用户类型
        function getUserTypeByLevel(level) {
            switch (level) {
                case 0: return 'super_admin';
                case 1: return 'admin';
                case 2: return 'salesperson';
                case 3: return 'user';
                default: return 'user';
            }
        }

        // 根据权限等级获取用户类型显示名称
        function getUserTypeName(level) {
            switch (level) {
                case 0: return '超级管理员';
                case 1: return '管理员';
                case 2: return '业务员';
                case 3: return '注册用户';
                default: return '用户';
            }
        }

        // 应用权限控制
        function applyPermissionControls() {
            // 重新生成当前菜单以应用权限过滤
            if (currentSection) {
                generateCategoryMenu(currentSection);
                
                // 如果当前分类无权限访问，切换到有权限的分类
                const availableCategories = getAvailableCategories(currentSection);
                if (currentCategory && !availableCategories.find(cat => cat.id === currentCategory)) {
                    if (availableCategories.length > 0) {
                        showCategory(availableCategories[0].id);
                    }
                }
            }
            
            // 更新用户信息显示
            updateUserInfoDisplay();
        }

        // 更新用户信息显示
        function updateUserInfoDisplay() {
            // 更新侧边栏的用户类型显示
            const userTypeLabel = document.getElementById('userTypeLabel');
            if (userTypeLabel) {
                userTypeLabel.textContent = getUserTypeName(currentUserPermissions.permissionLevel);
            }
            
            // 更新侧边栏的用户名显示
            const userInfoElement = document.querySelector('.sidebar-header .user-info');
            if (userInfoElement) {
                const typeName = getUserTypeName(currentUserPermissions.permissionLevel);
                const username = currentUserPermissions.username;
                userInfoElement.innerHTML = `${typeName} - ${username}`;
            }
            
            // 在页面顶部显示当前用户信息（如果有navbar-brand元素）
            const navbarBrand = document.querySelector('.navbar-brand');
            if (navbarBrand && currentUserPermissions.username !== '管理员') {
                navbarBrand.innerHTML += ` <small class="text-muted">(${currentUserPermissions.username})</small>`;
            }
        }

        // 检查特定资源权限
        async function checkResourcePermission(resource) {
            try {
                const authToken = localStorage.getItem('authToken') || localStorage.getItem('adminToken');
                const response = await fetch(`${API_BASE_URL}/api/admin/permissions/check?resource=${resource}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.hasPermission;
                } else {
                    return false;
                }
            } catch (error) {
                console.error('权限检查失败:', error);
                return false;
            }
        }

        // 权限拦截器 - 在访问敏感功能前调用
        async function requirePermission(resource, action = '访问此功能') {
            const hasPermission = await checkResourcePermission(resource);
            
            if (!hasPermission) {
                Swal.fire({
                    title: '权限不足',
                    text: `您没有权限${action}`,
                    icon: 'warning',
                    confirmButtonText: '确定'
                });
                return false;
            }
            
            return true;
        }
    </script>
</body>
</html>







